<!DOCTYPE HTML>
<html lang="en" class="navy" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AUTD3 Developers Manual v18.0.1</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./theme/codeblock_filename.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('navy')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="about_AUTD3.html"><strong aria-hidden="true">1.</strong> AUTD3について</a></li><li class="chapter-item expanded "><a href="Users_Manual/users_manual.html"><strong aria-hidden="true">2.</strong> SDK ユーザーズマニュアル</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/concept.html"><strong aria-hidden="true">2.1.</strong> コンセプト</a></li><li class="chapter-item expanded "><a href="Users_Manual/getting_started.html"><strong aria-hidden="true">2.2.</strong> チュートリアル</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/getting_started/rust.html"><strong aria-hidden="true">2.2.1.</strong> Rust</a></li><li class="chapter-item expanded "><a href="Users_Manual/getting_started/cpp.html"><strong aria-hidden="true">2.2.2.</strong> C++</a></li><li class="chapter-item expanded "><a href="Users_Manual/getting_started/cs.html"><strong aria-hidden="true">2.2.3.</strong> C#</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/getting_started/unity.html"><strong aria-hidden="true">2.2.3.1.</strong> Unity</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/getting_started/python.html"><strong aria-hidden="true">2.2.4.</strong> Python</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/versioning.html"><strong aria-hidden="true">2.3.</strong> バージョニング</a></li><li class="chapter-item expanded "><a href="Users_Manual/geometry.html"><strong aria-hidden="true">2.4.</strong> Geometry</a></li><li class="chapter-item expanded "><a href="Users_Manual/link.html"><strong aria-hidden="true">2.5.</strong> Link</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/link/twincat.html"><strong aria-hidden="true">2.5.1.</strong> TwinCAT</a></li><li class="chapter-item expanded "><a href="Users_Manual/link/soem.html"><strong aria-hidden="true">2.5.2.</strong> SOEM</a></li><li class="chapter-item expanded "><a href="Users_Manual/link/simulator.html"><strong aria-hidden="true">2.5.3.</strong> Simulator</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/gain.html"><strong aria-hidden="true">2.6.</strong> Gain</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/gain/null.html"><strong aria-hidden="true">2.6.1.</strong> Null</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/focus.html"><strong aria-hidden="true">2.6.2.</strong> Focus</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/bessel.html"><strong aria-hidden="true">2.6.3.</strong> Bessel</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/plane.html"><strong aria-hidden="true">2.6.4.</strong> Plane</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/uniform.html"><strong aria-hidden="true">2.6.5.</strong> Uniform</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/grouped.html"><strong aria-hidden="true">2.6.6.</strong> Group</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/holo.html"><strong aria-hidden="true">2.6.7.</strong> Holo</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/cache.html"><strong aria-hidden="true">2.6.8.</strong> Cache</a></li><li class="chapter-item expanded "><a href="Users_Manual/gain/transform.html"><strong aria-hidden="true">2.6.9.</strong> Transform</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/modulation.html"><strong aria-hidden="true">2.7.</strong> Modulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/modulation/static.html"><strong aria-hidden="true">2.7.1.</strong> Static</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/sine.html"><strong aria-hidden="true">2.7.2.</strong> Sine</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/modulation/fourier.html"><strong aria-hidden="true">2.7.2.1.</strong> Fourier</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/square.html"><strong aria-hidden="true">2.7.3.</strong> Square</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/wav.html"><strong aria-hidden="true">2.7.4.</strong> Wav</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/rawpcm.html"><strong aria-hidden="true">2.7.5.</strong> RawPCM</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/cache.html"><strong aria-hidden="true">2.7.6.</strong> Cache</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/radiation.html"><strong aria-hidden="true">2.7.7.</strong> Radiation</a></li><li class="chapter-item expanded "><a href="Users_Manual/modulation/transform.html"><strong aria-hidden="true">2.7.8.</strong> Transform</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/stm.html"><strong aria-hidden="true">2.8.</strong> Spatio-Temporal Modulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/stm/focus.html"><strong aria-hidden="true">2.8.1.</strong> FocusSTM</a></li><li class="chapter-item expanded "><a href="Users_Manual/stm/gain.html"><strong aria-hidden="true">2.8.2.</strong> GainSTM</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/silencer.html"><strong aria-hidden="true">2.9.</strong> Silencer</a></li><li class="chapter-item expanded "><a href="Users_Manual/controller.html"><strong aria-hidden="true">2.10.</strong> Controller</a></li><li class="chapter-item expanded "><a href="Users_Manual/advanced_examples/advanced_examples.html"><strong aria-hidden="true">2.11.</strong> 上級者向けサンプル</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Users_Manual/advanced_examples/custom_gain.html"><strong aria-hidden="true">2.11.1.</strong> Gainの自作</a></li><li class="chapter-item expanded "><a href="Users_Manual/advanced_examples/custom_modulation.html"><strong aria-hidden="true">2.11.2.</strong> Modulationの自作</a></li></ol></li><li class="chapter-item expanded "><a href="Users_Manual/Simulator/simulator.html"><strong aria-hidden="true">2.12.</strong> シミュレータ</a></li><li class="chapter-item expanded "><a href="Users_Manual/FAQ/faq.html"><strong aria-hidden="true">2.13.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="Users_Manual/Citation/citation.html"><strong aria-hidden="true">2.14.</strong> 引用</a></li><li class="chapter-item expanded "><a href="Users_Manual/LICENSE.html"><strong aria-hidden="true">2.15.</strong> ライセンス</a></li><li class="chapter-item expanded "><a href="Users_Manual/release_notes.html"><strong aria-hidden="true">2.16.</strong> リリースノート</a></li></ol></li><li class="chapter-item expanded "><a href="document_history.html"><strong aria-hidden="true">3.</strong> ドキュメント履歴</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AUTD3 Developers Manual v18.0.1</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shinolab/autd3" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="autd3について"><a class="header" href="#autd3について">AUTD3について</a></h1>
<p>AUTD3は空中触覚用超音波フェーズドアレイデバイスである.
超音波フェーズドアレイとは, 位相を個別に制御できる超音波振動子を (典型的には格子状に) 配列したものである.
超音波の位相を制御することで, 空間に任意の音場を発生させることができる.</p>
<p>フェーズドアレイを用いて十分に集束させた音波のエネルギーは, 音響放射圧を生じる.
この圧力を利用して, 人体の表面を非接触で押すことができる.
集束焦点の位置は, フェーズドアレイを電子的に制御することで自由に制御できる.
また, 逆問題を解くことで, 単一の焦点だけでなく, より複雑な音圧空間分布を作ることもできる.</p>
<p>フェーズドアレイで生成できる圧力の大きさの上限は, 現在のところ約<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">50</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mN/c</span><span class="mord"><span class="mord mathrm">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">2</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">5</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">gf/c</span><span class="mord"><span class="mord mathrm">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>である.
また, 空間分解能は使用する波長程度までとなる (例えば, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">40</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>で約<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">8.5</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>).
フェーズドアレイにはこのような制約はあるものの, 力の時空間分布を自由にデザインし, さまざまな触覚を作り出すことができる技術として注目されている.</p>
<p>このように非接触で触覚を刺激する技術分野を<strong>空中触覚 (Midair Haptics)</strong> と呼び, 我々はこの超音波空中触覚装置を<strong>Airborne Ultrasound Tactile Display (AUTD)</strong> と呼んでいる.
AUTDの本質的な部分は, 2008年<sup class="footnote-reference"><a href="#1">1</a></sup>から2010年代初頭<sup class="footnote-reference"><a href="#2">2</a></sup>にかけて, 東京大学によって提案・確立された.
その後, 各国の大学や企業が参入し, 活発な研究開発が行われている.
AUTD3は我々東京大学篠田牧野研究室で開発しているAUTDの3代目のバージョンである.</p>
<p><a href="https://hapislab.org/airborne-ultrasound-tactile-display">研究室のホームページ</a>にAUTDを使った研究の一覧が掲載されている. こちらも参照されたい.</p>
<p>本マニュアルはこのAUTD3を操作するための<a href="https://github.com/shinolab/autd3">autd3</a>ソフトウェアライブラリについてまとめたものである.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://hapislab.org/public/hiroyuki_shinoda/research/pdf/08Eurohaptics_iwamoto.pdf">Takayuki Iwamoto, Mari Tatezono, and Hiroyuki Shinoda: Non-contact Method for Producing Tactile Sensation Using Airborne Ultrasound, Haptics: Perception, Devices and Scenarios: 6th International Conference, Eurohaptics 2008 Proceedings (Lecture Notes in Computer Science), pp.504-513, 2008.</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://hapislab.org/public/hiroyuki_shinoda/research/pdf/10_Trans_Haptics_Hoshi.pdf">Takayuki Hoshi, Masafumi Takahashi, Takayuki Iwamoto, and Hiroyuki Shinoda: Noncontact Tactile Display Based on Radiation Pressure of Airborne Ultrasound, IEEE Trans. on Haptics, Vol. 3, No. 3, pp.155-165, 2010.</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="ユーザーズマニュアル"><a class="header" href="#ユーザーズマニュアル">ユーザーズマニュアル</a></h1>
<p>以下では, ライブラリの基本的な使用方法について述べる.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="コンセプト"><a class="header" href="#コンセプト">コンセプト</a></h1>
<p>SDKを構成する主なコンポーネントは以下の通りである.</p>
<ul>
<li><code>Controller</code> - コントローラクラス. AUTD3に対する全ての操作はこのクラスを介して行う</li>
<li><code>Geometry</code> - <code>Device</code>のコンテナ
<ul>
<li><code>Device</code> - AUTD3デバイスに対応するクラス</li>
</ul>
</li>
<li><code>Link</code> - クライアントとデバイスとのインターフェース</li>
<li><code>Gain</code> - 各振動子の位相/振幅を管理するクラス</li>
<li><code>Modulation</code> - AM変調を管理するクラス</li>
<li><code>STM</code> - ファームウェア上のSpatio-Temporal Modulation (STM, 時空間変調) 機能を管理するクラス</li>
</ul>
<p>以下にAUTD3の前面と背面写真を載せる.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/autd_trans_idx.jpg"/>
  <figcaption>AUTDの表面写真</figcaption>
</figure>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/autd_back.jpg"/>
  <figcaption>AUTD背面写真</figcaption>
</figure>
<p>AUTD3は一台あたり249個の振動子から構成されている<sup class="footnote-reference"><a href="#fn_asm">1</a></sup>.
SDKからはこの全ての振動子の位相/振幅をそれぞれ個別に指定できるようになっている.
AUTD3の座標系は右手座標系を採用しており, 0番目の振動子の中心が原点になる.
x軸は長軸方向, すなわち, 0→17の方向であり, y軸は0→18の方向である.
また, 単位系として, 距離はmm, 角度はrad, 周波数はHzを採用している.
振動子は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">10.16</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>の間隔で配置されており, 基板を含めたサイズは<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">192</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">151.4</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>となっている.</p>
<p>以下に振動子アレイの寸法を載せる.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/transducers_array.jpg"/>
  <figcaption>AUTD3デバイスの寸法</figcaption>
</figure>
<p>さらに, AUTD3は復数のデバイスをデイジーチェインで接続し拡張できるようになっている.
PCと1台目のEherCAT In をイーサネットケーブルを繋ぎ, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>台目のEherCAT Outと<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>台目のEherCAT Inを繋ぐことで拡張アレイを構成できる.
この時, イーサネットケーブルはCAT 5e以上のものを使用すること.</p>
<p>AUTD3の電源は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">24</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm" style="margin-right:0.01389em;">V</span></span></span></span></span>の直流電源を使用する. 電源についても相互に接続でき, 電源コネクタは3つの内で好きなところを使って良い.
なお, 電源のコネクタはMolex社5566-02Aを使用している.</p>
<blockquote>
<p>NOTE: AUTD3は最大でデバイスあたり<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">A</span></span></span></span></span>の電流を消費する. 電源の最大出力電流に注意されたい.</p>
</blockquote>
<div class="footnote-definition" id="fn_asm"><sup class="footnote-definition-label">1</sup>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">18</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">14</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">252</span></span></span></span>からネジ用に3つの振動子が抜けている. 態々この位置にネジ穴を持ってきたのは, 複数台並べたときの隙間を可能な限り小さくしようとしたため.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="チュートリアル"><a class="header" href="#チュートリアル">チュートリアル</a></h1>
<p>ここでは, 実際にAUTD3を動かす手順について述べる.</p>
<h2 id="依存プログラムのインストール"><a class="header" href="#依存プログラムのインストール">依存プログラムのインストール</a></h2>
<p>本チュートリアルではSOEMを利用する.
Windowsを使用する場合, <a href="https://npcap.com/">Npcap</a>を「WinPcap API-compatible Mode」でインストールしておくこと.</p>
<h2 id="デバイスのセットアップ"><a class="header" href="#デバイスのセットアップ">デバイスのセットアップ</a></h2>
<p>まず, デバイスをセットアップする.
ここでは一台のAUTD3のみを使うこととする.
PCのイーサネットポートとAUTD3デバイスのEtherCAT In (<a href="Users_Manual/concept.html">Concept</a>参照) をイーサネットケーブルで接続する.
次に, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">24</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm" style="margin-right:0.01389em;">V</span></span></span></span></span>電源を接続する.</p>
<h3 id="ファームウェアアップデート"><a class="header" href="#ファームウェアアップデート">ファームウェアアップデート</a></h3>
<p>ファームウェアが古い場合, 正常な動作は保証されない.
本文章におけるファームウェアのバージョンはv4.0.xが想定される.</p>
<p>ファームウェアのアップデートには<a href="https://www.xilinx.com/products/design-tools/vivado.html">Vivado</a>, 及び, <a href="https://www.segger.com/downloads/jlink/">J-Link Software</a>をインストールしたWindows 10/11 64bit PCが必要である.
なお, Vivado 2023.1, 及び, J-Link Software v7.82a (x64)での動作を確認している.</p>
<blockquote>
<p>NOTE: ファームウェアのアップデートだけが目的であれば, “Vivado Lab Edition“の使用を強く推奨する. 
ML Edition はインストールに60 GB以上のディスク容量を要求する. Lab Edition は6 GB程度のディスク容量で済む. </p>
</blockquote>
<p>まず, AUTD3デバイスとPCを<a href="https://www.xilinx.com/products/boards-and-kits/hw-usb-ii-g.html">XILINX Platform Cable</a>, 及び, <a href="https://www.segger-pocjapan.com/j-link-9-pin-cortex-m-adapter">J-Link 9-Pin Cortex-M Adapter</a>付きの<a href="https://www.segger.com/products/debug-probes/j-link/models/j-link-plus/">J-Link Plus</a>で接続し, AUTD3の電源を入れる.
次に, <a href="https://github.com/shinolab/autd3">SDK</a>内の<code>firmware/autd_firmware_writer.ps1</code>をpowershellから実行し, 指示に従えばよい. updateには数分の時間を要する.</p>
<h2 id="各言語ごとのサンプルプログラム"><a class="header" href="#各言語ごとのサンプルプログラム">各言語ごとのサンプルプログラム</a></h2>
<ul>
<li><a href="Users_Manual/./getting_started/rust.html">Rust</a></li>
<li><a href="Users_Manual/./getting_started/cpp.html">C++</a></li>
<li><a href="Users_Manual/./getting_started/cs.html">C#</a>
<ul>
<li><a href="Users_Manual/./getting_started/unity.html">Unity</a></li>
</ul>
</li>
<li><a href="Users_Manual/./getting_started/python.html">Python</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rust版チュートリアル"><a class="header" href="#rust版チュートリアル">Rust版チュートリアル</a></h1>
<p>まずは適当なプロジェクトを作成し, <code>autd3</code>ライブラリを依存関係に追加する.
また, デバイスとの通信を行う<code>autd3-link-soem</code>ライブラリも依存関係に追加する.</p>
<pre><code class="language-shell">cargo new --bin autd3-sample
cd autd3-sample
cargo add autd3
cargo add autd3-link-soem
cargo add tokio --features full
</code></pre>
<p>次に, <code>src/main.rs</code>ファイルを編集し, 以下のようにする.
これは単一焦点に<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>のAM変調をかける場合のソースコードである.</p>
<pre><code class="language-rust should_panic filename=main.rs edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_soem;
</span>use autd3::prelude::*;
use autd3_link_soem::SOEM;

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    // AUTDを操作するControllerの作成
    let mut autd = Controller::builder()
        // 接続しているデバイス情報の登録
        // AUTD3::newの引数は位置
        // 位置は自分の設定した座標系におけるこのデバイスの位置を指定する
        // ここでは, デバイスは原点に置かれるする
        .add_device(AUTD3::new(Vector3::zeros()))
        // SOEMリンクを使用してControllerをopenする
        // with_on_lostで指定したコールバックはSOEMがデバイスをロストしたときに呼ばれる 
        .open_with(SOEM::builder().with_on_lost(|msg| {
            eprintln!(&quot;Unrecoverable error occurred: {msg}&quot;);
            std::process::exit(-1);
        })).await?;

    // ファームウェアバージョンのチェック
    // ここで, v4.0.x以外が表示される場合の動作は保証しない
    autd.firmware_infos().await?.iter().for_each(|firm_info| {
        println!(&quot;{}&quot;, firm_info);
    });

    // 静音化処理を有効化
    // なお, デフォルトで有効にされているので, 実際には必要ない
    // 無効にしたい場合はSilencer::disable()を送信する
    autd.send(Silencer::default()).await?;

    // デバイスの中心から直上150mmに焦点
    let center = autd.geometry.center() + Vector3::new(0., 0., 150.0 * MILLIMETER);
    let g = Focus::new(center);

    // 150Hzサイン波変調
    let m = Sine::new(150.);

    // データの送信
    autd.send((m, g)).await?;

    println!(&quot;press enter to quit...&quot;);
    let mut _s = String::new();
    std::io::stdin().read_line(&amp;mut _s)?;

    // コントローラーを閉じる
    autd.close().await?;

    Ok(())
}</code></pre>
<p>そして, これを実行する.</p>
<pre><code class="language-shell">cargo run --release
</code></pre>
<h2 id="linuxmacos使用時の注意"><a class="header" href="#linuxmacos使用時の注意">Linux,macOS使用時の注意</a></h2>
<p>Linux, macOSでは, SOEMを使用するのに管理者権限が必要な場合がある.
その場合は, </p>
<pre><code class="language-shell">cargo build --release &amp;&amp; sudo ./target/release/autd3_sample
</code></pre>
<p>とすること.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="c版チュートリアル"><a class="header" href="#c版チュートリアル">C++版チュートリアル</a></h1>
<h2 id="依存プログラムのインストール-1"><a class="header" href="#依存プログラムのインストール-1">依存プログラムのインストール</a></h2>
<p>本チュートリアルでは<a href="https://cmake.org/">CMake</a>を使用するので, インストールしておくこと.</p>
<h2 id="autd3クライアントプログラムの作成"><a class="header" href="#autd3クライアントプログラムの作成">AUTD3クライアントプログラムの作成</a></h2>
<p>まず, ターミナルを開き, 適当なディレクトリを用意する.</p>
<pre><code class="language-shell">mkdir autd3-sample
cd autd3-sample
</code></pre>
<p>次に, <code>CMakeLists.txt</code>, <code>main.cpp</code>ファイルを作成する.</p>
<pre><code class="language-shell filename=">└─autd3-sample
        CMakeLists.txt
        main.cpp
</code></pre>
<p>次に, <code>CMakeLists.txt</code>を以下のようにする.</p>
<pre><code class="language-ignore filename=CMakeLists.txt">cmake_minimum_required(VERSION 3.21)

project(autd3-sample)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

if(${CMAKE_VERSION} VERSION_GREATER_EQUAL &quot;3.24.0&quot;) 
  cmake_policy(SET CMP0135 NEW)
endif()

include(FetchContent)
if(WIN32)
  FetchContent_Declare(
    autd3
    URL https://github.com/shinolab/autd3/releases/download/v18.0.1/autd3-v18.0.1-win-x64.zip
  )
elseif(APPLE)
  FetchContent_Declare(
    autd3
    URL https://github.com/shinolab/autd3/releases/download/v18.0.1/autd3-v18.0.1-macos-universal.tar.gz
  )
else()
  FetchContent_Declare(
    autd3
    URL https://github.com/shinolab/autd3/releases/download/v18.0.1/autd3-v18.0.1-linux-x64.tar.gz
  )
endif()
set(USE_SYSTEM_EIGEN OFF)
FetchContent_MakeAvailable(autd3)

add_executable(main main.cpp)

autd3_target_link_library(main PRIVATE)

if (CMAKE_GENERATOR MATCHES &quot;Visual Studio&quot;)
    set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT main)
endif()
</code></pre>
<blockquote>
<p>NOTE: 上記の例では, 依存ライブラリ (Eigen3) を自動的にダウンロードするようになっている.
すでにEigen3がインストールされている場合, <code>USE_SYSTEM_EIGEN </code>をONにすると, 自動ダウンロードを無効化し, インストール済みのものを使用できる.</p>
</blockquote>
<p>また, <code>main.cpp</code>を以下のようにする. これは単一焦点に<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>のAM変調をかける場合のソースコードである.</p>
<pre><code class="language-cpp filename=main.cpp">#include &lt;iostream&gt;

#include &quot;autd3.hpp&quot;
#include &quot;autd3/link/soem.hpp&quot;

void on_lost(const char* msg) {
  std::cerr &lt;&lt; &quot;Link is lost\n&quot;;
  std::cerr &lt;&lt; msg;
  exit(-1);
}

int main() try {
  // create and open controller
  auto autd =
      autd3::ControllerBuilder()
          // The  argument is the position.
          // The position is the origin of the device in the global coordinate
          // system you set.
          .add_device(autd3::AUTD3(autd3::Vector3::Zero()))
          .open_with_async(autd3::link::SOEM::builder().with_on_lost(&amp;on_lost))
          .get();

  // check firmware version
  const auto firm_infos = autd.firmware_infos_async().get();
  std::copy(firm_infos.begin(), firm_infos.end(),
            std::ostream_iterator&lt;autd3::FirmwareInfo&gt;(std::cout, &quot;\n&quot;));

  // Silencer is used to quiet down the transducers' noise by passing the
  // phase/amplitude parameters through a low-pass filter.
  autd3::Silencer silencer;
  autd.send_async(silencer).get();

  // focus is 150.0 mm above array center
  const autd3::Vector3 focus =
      autd.geometry().center() + autd3::Vector3(0.0, 0.0, 150.0);
  autd3::gain::Focus g(focus);

  // Amplitude Modulation of 150 Hz sine wave
  autd3::modulation::Sine m(150);

  // send data
  autd.send_async(m, g).get();

  std::cout &lt;&lt; &quot;press enter to finish...&quot; &lt;&lt; std::endl;
  std::cin.ignore();

  // close controller
  (void)autd.close_async().get();

  return 0;
} catch (std::exception&amp; ex) {
  std::cerr &lt;&lt; ex.what() &lt;&lt; std::endl;
}
</code></pre>
<p>次に, CMakeでビルドする.</p>
<pre><code class="language-shell">mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --config Release
</code></pre>
<p>これで, <code>Release</code>以下に実行ファイルが生成されるので, これを実行する.</p>
<pre><code class="language-shell filename=Windows">.\Release\main.exe
</code></pre>
<pre><code class="language-shell filename=Linux/macOS">sudo ./main
</code></pre>
<h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<ul>
<li>anaconda (miniconda) がactivateされている場合に, ビルドエラーになる可能性がある.
<ul>
<li>この場合, <code>build</code>ディレクトリを削除し, <code>conda deactivate</code>を実行したのち再び<code>cmake</code>を実行する.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="c版チュートリアル-1"><a class="header" href="#c版チュートリアル-1">C#版チュートリアル</a></h1>
<p>まず, ターミナルを開き, 適当なプロジェクトを作成し, AUTD3Sharpライブラリを追加する.</p>
<pre><code class="language-shell">dotnet new console --name autd3-sample
cd autd3-sample
dotnet add package AUTD3Sharp
</code></pre>
<p>次に, <code>Program.cs</code>を以下のようにする.
これは単一焦点に<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>のAM変調をかける場合のソースコードである.</p>
<pre><code class="language-csharp filename=Program.cs">﻿using AUTD3Sharp;
using AUTD3Sharp.Utils;
using AUTD3Sharp.Link;
using AUTD3Sharp.Gain;
using AUTD3Sharp.Modulation;

var onLost = new SOEM.OnErrCallbackDelegate((string msg) =&gt;
{
    Console.WriteLine($&quot;Unrecoverable error occurred: {msg}&quot;);
    Environment.Exit(-1);
});

using var autd = await new ControllerBuilder()
        .AddDevice(new AUTD3(Vector3d.zero))
        .OpenWithAsync(SOEM.Builder().WithOnLost(onLost));

var firmList = await autd.FirmwareInfoListAsync();
foreach (var firm in firmList)
    Console.WriteLine(firm);

await autd.SendAsync(new Silencer());

var g = new Focus(autd.Geometry.Center + new Vector3d(0, 0, 150));
var m = new Sine(150);
await autd.SendAsync(m, g);

Console.ReadKey(true);

await autd.CloseAsync();
</code></pre>
<p>そして, これを実行する.</p>
<pre><code class="language-shell">dotnet run -c:Release
</code></pre>
<h2 id="linuxmacos使用時の注意-1"><a class="header" href="#linuxmacos使用時の注意-1">Linux,macOS使用時の注意</a></h2>
<p>Linux, macOSでは, SOEMを使用するのに管理者権限が必要な場合がある.
その場合は, </p>
<pre><code class="language-shell">sudo dotnet run -c:Release
</code></pre>
<p>とすること.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="unity版チュートリアル"><a class="header" href="#unity版チュートリアル">Unity版チュートリアル</a></h1>
<p>Unity版のライブラリは座標系がz軸反転の左手系になり, 距離の基本単位がmになっているので注意すること.
また, 浮動小数点数型に<code>double</code>ではなく, <code>float</code>を使用している.</p>
<h2 id="インストール"><a class="header" href="#インストール">インストール</a></h2>
<p>Unity Package Manager経由でインストールする.</p>
<ol>
<li>「メニューバー」→「Edit」→「Project Settings」から「Package Manager」を開く</li>
<li>「Scoped Registry」にて以下を追加し, 保存する
<ul>
<li>Name    : shinolab</li>
<li>URL     : https://registry.npmjs.com</li>
<li>Scope(s): com.shinolab</li>
</ul>
</li>
<li>「メニューバー」→「Window」→「Package Manager」を開く</li>
<li>左上の「Packages」ドロップダウンメニューから, 「My Registries」を選択する </li>
<li>OSに応じて以下のパッケージをインストールする
<ul>
<li>Windows: <code>autd3-unity</code></li>
<li>macOS: <code>autd3-unity-mac</code></li>
<li>Linux: <code>autd3-unity-linux</code></li>
</ul>
</li>
</ol>
<p>Unity版はサンプルプログラムが付属しているので, そちらを参照されたい.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="python版チュートリアル"><a class="header" href="#python版チュートリアル">Python版チュートリアル</a></h1>
<h2 id="pyautd3ライブラリのインストール"><a class="header" href="#pyautd3ライブラリのインストール">pyautd3ライブラリのインストール</a></h2>
<pre><code class="language-shell">pip install pyautd3
</code></pre>
<p>次に, <code>main.py</code>を作成し, 以下のようにする.
これは単一焦点に<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>のAM変調をかける場合のソースコードである.</p>
<pre><code class="language-python filename=main.py">import asyncio
import ctypes
import os
from typing import NoReturn

import numpy as np
from pyautd3 import AUTD3, Controller, Silencer
from pyautd3.gain import Focus
from pyautd3.link.soem import SOEM, OnErrFunc
from pyautd3.modulation import Sine


def on_lost(msg: ctypes.c_char_p) -&gt; NoReturn:
    print(msg.decode(&quot;utf-8&quot;), end=&quot;&quot;)
    os._exit(-1)


def on_err(msg: ctypes.c_char_p) -&gt; None:
    print(msg.decode(&quot;utf-8&quot;), end=&quot;&quot;)


async def main() -&gt; None:
    on_lost_func = OnErrFunc(on_lost)
    on_err_func = OnErrFunc(on_err)

    with await (
        Controller.builder()
        .add_device(AUTD3([0.0, 0.0, 0.0]))
        .open_with_async(
            SOEM.builder().with_on_lost(on_lost_func).with_on_err(on_err_func)
        )
    ) as autd:
        firm_info_list = await autd.firmware_info_list_async()
        print(&quot;\n&quot;.join([f&quot;[{i}]: {firm}&quot; for i, firm in enumerate(firm_info_list)]))

        await autd.send_async(Silencer())

        g = Focus(autd.geometry.center + np.array([0.0, 0.0, 150.0]))
        m = Sine(150)
        await autd.send_async(m, g)

        _ = input()

        await autd.close_async()


if __name__ == &quot;__main__&quot;:
    asyncio.run(main())
</code></pre>
<p>そして, これを実行する.</p>
<pre><code class="language-shell">python main.py
</code></pre>
<h2 id="linux使用時の注意"><a class="header" href="#linux使用時の注意">Linux使用時の注意</a></h2>
<p>Linuxでは, SOEMを使用するのに管理者権限が必要な場合がある.
その場合は, </p>
<pre><code class="language-shell">sudo setcap cap_net_raw,cap_net_admin=eip &lt;your python path&gt;
</code></pre>
<p>とした後, <code>main.py</code>を実行する.</p>
<pre><code class="language-shell">python main.py
</code></pre>
<h2 id="macos使用時の注意"><a class="header" href="#macos使用時の注意">macOS使用時の注意</a></h2>
<p>macOSでは, SOEMを使用するのに管理者権限が必要な場合がある.
その場合は, </p>
<pre><code class="language-shell">sudo chmod +r /dev/bpf*
</code></pre>
<p>とした後, <code>main.py</code>を実行する.</p>
<pre><code class="language-shell">python main.py
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="バージョニング"><a class="header" href="#バージョニング">バージョニング</a></h1>
<p>AUTD3はv8.2.0から<a href="https://semver.org/lang/ja/">セマンティック バージョニング</a>に従っている.</p>
<p>AUTD3 SDKのバージョンはvX.Y.Zと表記される.</p>
<ul>
<li>Xはメジャーバージョンを表し, これが異なるSDK間では互換性は保証されない.</li>
<li>Yはマイナーバージョンを表し, 後方互換性を保つような機能追加があった場合に上げられる.</li>
<li>Zはパッチバージョンを表し, 後方互換性を保つようなバグ修正があった場合に上げられる.</li>
</ul>
<h2 id="ファームウェアのバージョン"><a class="header" href="#ファームウェアのバージョン">ファームウェアのバージョン</a></h2>
<p>ファームウェアのバージョンもvX.Y.Zと表記され, セマンティク バージョニングに従う.</p>
<p>ただし, ファームウェアのバージョンはソフトウェアのバージョンとは異なる.
ソフトウェアv17.0.0以降に対応するのはファームウェアv4.0.0以降である.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="geometry"><a class="header" href="#geometry">Geometry</a></h1>
<p>この章ではGeometryについて解説する.
GeometryはAUTD3デバイスが現実世界でどのように配置されているかを管理している.</p>
<ul>
<li><a href="Users_Manual/geometry.html#%E8%A4%87%E6%95%B0%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%81%AE%E6%8E%A5%E7%B6%9A">複数デバイスの接続</a></li>
<li><a href="Users_Manual/geometry.html#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E6%8C%AF%E5%8B%95%E5%AD%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9">デバイス/振動子のインデックス</a></li>
<li><a href="Users_Manual/geometry.html#geometry%E3%81%AEapi">GeometryのAPI</a>
<ul>
<li><a href="Users_Manual/geometry.html#device%E3%81%AE%E5%8F%96%E5%BE%97">Deviceの取得</a></li>
</ul>
</li>
<li><a href="Users_Manual/geometry.html#device%E3%81%AEapi">DeviceのAPI</a>
<ul>
<li><a href="Users_Manual/geometry.html#transducer%E3%81%AE%E5%8F%96%E5%BE%97">Transducerの取得</a></li>
</ul>
</li>
<li><a href="Users_Manual/geometry.html#transducer%E3%81%AEapi">TransducerのAPI</a></li>
</ul>
<h2 id="複数デバイスの接続"><a class="header" href="#複数デバイスの接続">複数デバイスの接続</a></h2>
<p>AUTD3のデバイスは複数台をデイジーチェーンで接続できるようになっている.
SDKは複数台を接続したとしても, 透過的に使用できるように設計されている.</p>
<p>複数のデバイスを接続する場合は,
PCと1台目のEtherCAT Inをケーブルでつなぎ, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>台目のEtherCAT Outと<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>台目のEtherCAT Inをケーブルで接続する (<a href="Users_Manual/concept.html">Concept</a>参照).</p>
<p>なお, 電源も相互に接続でき, 電源コネクタは3つの内で好きなところを使って良い.</p>
<blockquote>
<p>NOTE: AUTD3は最大でデバイスあたり<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">A</span></span></span></span></span>の電流を消費する. 電源の最大出力電流に注意されたい.</p>
</blockquote>
<p>SDKで複数台のデバイスを使用する場合は<code>add_device</code>関数を<strong>接続したデバイスの順に</strong>呼び出す必要がある.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/hor_left_ori_left_1.png"/>
</figure>
<p>例えば, 上図のように配置・接続しており, 図左側のデバイスが1台目, 右側のデバイスが2台目だとする.
さらに, グローバル座標を1台目のローカル座標と同じようにとるとすると,</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = 
</span>Controller::builder()
    .add_device(AUTD3::new(Vector3::zeros()))
    .add_device(AUTD3::new(Vector3::new(AUTD3::DEVICE_WIDTH, 0., 0.)))
<span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

autd3::ControllerBuilder()
    .add_device(autd3::AUTD3(autd3::Vector3::Zero()))
    .add_device(autd3::AUTD3(autd3::Vector3(autd3::AUTD3::DEVICE_WIDTH, 0, 0)))
</code></pre>
<pre><code class="language-cs">new ControllerBuilder()
   .AddDevice(new AUTD3(Vector3d.zero))
   .AddDevice(new AUTD3(new Vector3d(AUTD3.DeviceWidth, 0, 0)))
</code></pre>
<pre><code class="language-python">from pyautd3 import AUTD3, Controller

Controller.builder()\
    .add_device(AUTD3([0.0, 0.0, 0.0]))\
    .add_device(AUTD3([AUTD3.device_width(), 0.0, 0.0]))
</code></pre>
<p>とすれば良い.
ここで, <code>AUTD3</code>コンストラクタの第1引数は位置, 第2引数は回転を表す.
回転はZYZのオイラー角, または, クオータニオンで指定する.
また, <code>AUTD3::DEVICE_WIDTH</code>はデバイスの (基板外形を含めた) 横幅である.
この例では, 回転はしないので, 第2引数はゼロで良い.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/hor_right_ori_left_1.png"/>
</figure>
<p>また, 例えば上図のように, グローバル座標を2台目のローカル座標と同じようにとるとすると,</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = 
</span>Controller::builder()
    .add_device(AUTD3::new(Vector3::new(-AUTD3::DEVICE_WIDTH, 0., 0.)))
    .add_device(AUTD3::new(Vector3::zeros()))
<span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

autd3::ControllerBuilder()
    .add_device(autd3::AUTD3(autd3::Vector3(-autd3::AUTD3::DEVICE_WIDTH, 0, 0)))
    .add_device(autd3::AUTD3(autd3::Vector3::Zero()))
</code></pre>
<pre><code class="language-cs">new ControllerBuilder()
   .AddDevice(new AUTD3(new Vector3d(-AUTD3.DeviceWidth, 0, 0)))
   .AddDevice(new AUTD3(Vector3d.zero))
</code></pre>
<pre><code class="language-python">from pyautd3 import AUTD3, Controller

Controller.builder()\
    .add_device(AUTD3([-AUTD3.device_width(), 0.0, 0.0]))\
    .add_device(AUTD3([0.0, 0.0, 0.0]))
</code></pre>
<p>とすれば良い.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/vert.png"/>
</figure>
<p>さらに, 例えば, 上図のように配置されており, 下が1台目, 左が2台目で, グローバル座標を1台目のローカル座標と同じだとすると,</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let autd = Controller::builder()
    .add_device(AUTD3::new(Vector3::zeros()))
    .add_device(
        AUTD3::new(Vector3::new(0., 0., AUTD3::DEVICE_WIDTH))
            .with_rotation(EulerAngle::ZYZ(0. * Rad, PI/2.0 * Rad, 0. * Rad)))
<span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

autd3::ControllerBuilder()
    .add_device(autd3::AUTD3(autd3::Vector3::Zero()))
    .add_device(autd3::AUTD3(autd3::Vector3(autd3::AUTD3::DEVICE_WIDTH, 0, 0))
                    .with_rotation(autd3::EulerAngles::from_zyz(
                        0 * rad, autd3::pi / 2 * rad, 0 * rad)))
</code></pre>
<pre><code class="language-cs">using static AUTD3Sharp.Angle.Units;

new ControllerBuilder()
   .AddDevice(new AUTD3(Vector3d.zero))
   .AddDevice(
      new AUTD3(new Vector3d(AUTD3.DeviceWidth, 0, 0))
         .WithRotation(EulerAngles.FromZYZ(0 * Rad, AUTD3.Pi / 2 * Rad, 0 * Rad)))
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3 import AUTD3, Controller
from pyautd3.geometry import EulerAngles, rad

Controller.builder()\
    .add_device(AUTD3([0.0, 0.0, 0.0]))\
    .add_device(
        AUTD3([AUTD3.device_width(), 0.0, 0.0]).with_rotation(
            EulerAngles.from_zyz(0 * rad, np.pi / 2 * rad, 0 * rad)))
</code></pre>
<p>のように指定する.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/hor_right_ori_right_1.png"/>
</figure>
<p><code>add_device</code>を呼び出す順番は接続した順番に依存することに注意する.
例えば, 上図のように配置・接続しており, 図右側のデバイスが1台目, 左側のデバイスが2台目だとする.
この場合は, 右側のデバイスの座標を先に指定する必要がある.</p>
<p>SDKにおけるAPIでは, すべてグローバル座標を用いるため, 接続するデバイスの数に依存せず透過的に使用できる.</p>
<h2 id="デバイス振動子のインデックス"><a class="header" href="#デバイス振動子のインデックス">デバイス/振動子のインデックス</a></h2>
<p>デバイスには接続された順に0から始まるインデックスが割り当てられる.</p>
<p>また, 各デバイスは<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">249</span></span></span></span>個の振動子が配置されており, ローカルインデックスが割り振られている (<a href="Users_Manual/./concept.html">コンセプト</a>の「AUTDの表面写真」を参照).</p>
<h2 id="geometryのapi"><a class="header" href="#geometryのapi">GeometryのAPI</a></h2>
<ul>
<li><code>num_devices</code>: デバイスの数を取得</li>
<li><code>num_transducers</code>: 全振動子の数を取得</li>
<li><code>center</code>: 全振動子の中心を取得</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span>let num_dev = autd.geometry.num_devices();
let num_tr = autd.geometry.num_transducers();
let center = autd.geometry.center();
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto num_dev = autd.geometry().num_devices();
const auto num_tr = autd.geometry().num_transducers();
const autd3::Vector3 center = autd.geometry().center();
</code></pre>
<pre><code class="language-cs">var numDevices = autd.Geometry.NumDevices;
var numTransducers = autd.Geometry.NumTransducers;
var center = autd.Geometry.Center;
</code></pre>
<pre><code class="language-python">num_devices = autd.geometry.num_devices
num_transducers = autd.geometry.num_transducers
center = autd.geometry.center
</code></pre>
<h3 id="deviceの取得"><a class="header" href="#deviceの取得">Deviceの取得</a></h3>
<p><code>Geometry</code>は<code>Device</code>のコンテナになっており, <code>Device</code>が<code>Transducer</code>のコンテナになっている.</p>
<p><code>Device</code>を取得するには, インデクサを使用する.
あるいは, イテレータを使用することもできる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span>let dev = &amp;autd.geometry[0];
for dev in &amp;autd.geometry {
    // do something
}
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">auto dev = autd.geometry()[0];
for (auto&amp; dev : autd.geometry()) {
  // do something
}
</code></pre>
<pre><code class="language-cs">var dev = autd.Geometry[0];
foreach (var dev in autd.Geometry)
{
  // do something
}
</code></pre>
<pre><code class="language-python">dev = autd.geometry[0]
for dev in autd.geometry:
    pass
</code></pre>
<h2 id="deviceのapi"><a class="header" href="#deviceのapi">DeviceのAPI</a></h2>
<ul>
<li><code>idx</code>: デバイスのインデックス</li>
<li><code>enable</code>: enableフラグ. オフにすると, 以降, そのデバイスのデータは更新されなくなる.
<ul>
<li>更新されなくなるだけで, 出力が止まるわけではないことに注意.</li>
</ul>
</li>
<li><code>sound_speed</code>: 音速の取得/設定. 単位はmm/s.</li>
<li><code>set_sound_speed_from_temp</code>: 温度から音速を設定. 温度の単位は摂氏である.デフォルトの音速は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">340</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm/s</span></span></span></span></span>となっており, これは, およそ摂氏15度での空気の音速に相当する.なお, <code>Geometry</code>にも同名の関数があり, それを使用することですべてのデバイスに対して温度から音速を設定できる.</li>
<li><code>attenuation</code>: 減衰係数の取得/設定. 単位はNp/mm. デフォルトでは, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>に設定されている.</li>
<li><code>translate</code>: 平行移動</li>
<li><code>rotate</code>: 回転</li>
<li><code>affine</code>: アフィン変換 (平行移動/回転)</li>
<li><code>force_fan</code>: ファン強制起動フラグ.
<ul>
<li>AUTD3デバイスにはファンがついており, Auto, Off, Onの3つのファンモードが有る. Autoモードでは温度監視ICがICの温度を監視し, 一定温度以上になると自動でファンを起動する.Offモードではファンは常時オフであり, Onモードでは常時オンになる. モードの切替は, ファン横のジャンパスイッチで行う. 少しわかりにくいが, 以下の図のようにファン側をショートするとAuto, 真ん中でOff, 右側でOnとなる.<figure>
  <img src="Users_Manual/../fig/Users_Manual/fan.jpg"/>
  <figcaption>AUTDファン制御用のジャンパスイッチ</figcaption>
</figure>
</li>
<li>Autoモードの場合は温度が高くなると自動的にファンが起動する.
<code>force_fan</code>フラグはこのAutoモードでファンを強制的に起動するためのフラグである.</li>
<li>実際にフラグが更新されるのは何らかのデータを送信したときになる. フラグの更新だけがしたい場合は<code>UpdateFlags</code>を送信すれば良い.</li>
</ul>
</li>
<li><code>reads_fpga_info</code>: FPGAの状態を取得するかどうか. 詳しくは<a href="Users_Manual/./controller.html#fpga_info">Controller/fpga_info</a>を参照.</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span>let mut dev = &amp;mut autd.geometry[0];
let idx = dev.idx();
dev.enable = false;
dev.sound_speed = 340e3;
dev.set_sound_speed_from_temp(15.);
dev.attenuation = 0.;
let t = Vector3::new(1., 0., 0.);
let r = UnitQuaternion::from_quaternion(Quaternion::new(1., 0., 0., 0.));
dev.translate(t);
dev.rotate(r);
dev.affine(t, r);
dev.force_fan = true;
dev.reads_fpga_info = true;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">auto dev = autd.geometry()[0];
const auto idx = dev.idx();
const auto enable = dev.enable();
dev.set_enable(false);
const auto sound_speed = dev.sound_speed();
dev.set_sound_speed(340e3);
dev.set_sound_speed_from_temp(15.);
const auto attenuation = dev.attenuation();
dev.set_attenuation(0);
const auto t = autd3::Vector3(1., 0., 0.);
const auto r = autd3::Quaternion(1., 0., 0., 0.);
dev.translate(t);
dev.rotate(r);
dev.affine(t, r);
dev.force_fan(true);
dev.reads_fpga_info(true);
</code></pre>
<pre><code class="language-cs">var dev = autd.Geometry[0];
var idx = dev.Idx;
dev.Enable = false;
dev.SoundSpeed = 340e3;
dev.SetSoundSpeedFromTemp(15);
dev.Attenuation = 0;
var t = new Vector3d(1, 0, 0);
var r = new Quaterniond(0, 0, 0, 1);
dev.Translate(t);
dev.Rotate(r);
dev.Affine(t, r);
dev.ForceFan = true;
dev.ReadsFPGAInfo = true;
</code></pre>
<pre><code class="language-python">dev = autd.geometry[0]
idx = dev.idx
dev.enable = False
dev.sound_speed = 340e3
dev.set_sound_speed_from_temp(15.0)
attenuation = dev.attenuation = 0
t = np.array([1.0, 0.0, 0.0])
r = np.array([1.0, 0.0, 0.0, 0.0])
dev.translate(t)
dev.rotate(r)
dev.affine(t, r)
dev.force_fan = True
dev.reads_fpga_info = True
</code></pre>
<h3 id="transducerの取得"><a class="header" href="#transducerの取得">Transducerの取得</a></h3>
<p><code>Device</code>は<code>Transducer</code>のコンテナになっており, <code>Transducer</code>は各振動子の情報を格納している.</p>
<p><code>Transducer</code>を取得するには, インデクサを使用する.
また, イテレータを使用することもできる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span>let tr = &amp;autd.geometry[0][0];
for tr in &amp;autd.geometry[0] {
    // do something
}
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">auto tr = autd.geometry()[0][0];
for (auto&amp; tr : autd.geometry()[0]) {
  // do something
}
</code></pre>
<pre><code class="language-cs">var tr = autd.Geometry[0][0];
foreach (var tr in autd.Geometry[0])
{
  // do something
}
</code></pre>
<pre><code class="language-python">tr = autd.geometry[0][0]
for tr in autd.geometry[0]:
    pass
</code></pre>
<h2 id="transducerのapi"><a class="header" href="#transducerのapi">TransducerのAPI</a></h2>
<p>以下の情報を取得できる.</p>
<ul>
<li><code>idx</code>: 振動子の(ローカル)インデックス</li>
<li><code>position</code>: 振動子の位置</li>
<li><code>rotation</code>: 振動子の回転. 回転はクオータニオンで表される.</li>
<li><code>x_direction</code>: 振動子のx方向ベクトル</li>
<li><code>y_direction</code>: 振動子のy方向ベクトル</li>
<li><code>z_direction</code>: 振動子のz方向ベクトル</li>
<li><code>wavelength</code>: 振動子の波長. 引数に音速を渡す必要がある.</li>
<li><code>wavenumber</code>: 振動子の波数. 引数に音速を渡す必要がある.</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">   .open_with(autd3::link::Nop::builder()).await?;
</span>let tr = &amp;autd.geometry[0][0];
let idx = tr.idx();
let position = tr.position();
let rotation = tr.rotation();
let x_dir = tr.x_direction();
let y_dir = tr.y_direction();
let z_dir = tr.z_direction();

let sound_speed = autd.geometry[0].sound_speed;
let wavelen = tr.wavelength(sound_speed);
let wavenum = tr.wavenumber(sound_speed);
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto tr = autd.geometry()[0][0];
const auto idx = tr.idx();
const autd3::Vector3 position = tr.position();
const auto rotation = tr.rotation();
const auto x_dir = tr.x_direction();
const auto y_dir = tr.y_direction();
const auto z_dir = tr.z_direction();

const auto sound_speed = autd.geometry()[0].sound_speed();
const auto wavelen = tr.wavelength(sound_speed);
const auto wavenum = tr.wavenumber(sound_speed);
</code></pre>
<pre><code class="language-cs">var tr = autd.Geometry[0][0];
var trIdx = tr.Idx;
var position = tr.Position;
var rotation = tr.Rotation;
var xDir = tr.XDirection;
var yDir = tr.YDirection;
var zDir = tr.ZDirection;

var soundSpeed = autd.Geometry[0].SoundSpeed;
var wavelen = tr.Wavelength(soundSpeed);
var wavenum = tr.Wavenumber(soundSpeed);
</code></pre>
<pre><code class="language-python">tr = autd.geometry[0][0]
idx = tr.idx
position = tr.position
rotation = tr.rotation
x_dir = tr.x_direction
y_dir = tr.y_direction
z_dir = tr.z_direction

sound_speed = autd.geometry[0].sound_speed
wavelen = tr.wavelength(sound_speed)
wavenum = tr.wavenumber(sound_speed)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="link"><a class="header" href="#link">Link</a></h1>
<p>LinkはAUTD3デバイスとのインターフェースである.
以下の中から一つを選択する必要がある.</p>
<ul>
<li><a href="Users_Manual/./link/twincat.html">TwinCAT/RemoteTwinCAT</a></li>
<li><a href="Users_Manual/./link/soem.html">SOEM/RemoteSOEM</a></li>
<li><a href="Users_Manual/./link/simulator.html">Simulator</a></li>
</ul>
<h2 id="linkに共通のオプション"><a class="header" href="#linkに共通のオプション">Linkに共通のオプション</a></h2>
<h3 id="タイムアウト時間"><a class="header" href="#タイムアウト時間">タイムアウト時間</a></h3>
<p><code>with_timeout</code>でデフォルトのタイムアウト時間を設定する.</p>
<ul>
<li>タイムアウト時間の詳細は<a href="Users_Manual/./controller.html#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88">Controller#send#タイムアウト</a>を参照されたい</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate autd3_link_soem;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">use autd3_link_soem::SOEM;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let link = SOEM::builder().with_timeout(std::time::Duration::from_millis(20));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/soem.hpp&quot;

autd3::link::SOEM::builder().with_timeout(std::chrono::milliseconds(20));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Link;

SOEM.Builder().WithTimeout(TimeSpan.FromMilliseconds(20))
</code></pre>
<pre><code class="language-python">from datetime import timedelta

from pyautd3.link.soem import SOEM

SOEM.builder().with_timeout(timedelta(milliseconds=20))
</code></pre>
<p>デフォルトで各Linkに対して適当な値が設定されている.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="twincat"><a class="header" href="#twincat">TwinCAT</a></h1>
<p>TwinCATはPCでEherCATを使用する際の唯一の公式の方法である.
TwinCATはWindowsのみをサポートする非常に特殊なソフトウェアであり, Windowsを半ば強引にリアルタイム化する.</p>
<p>また, 特定のネットワークコントローラが求められるため,
<a href="https://infosys.beckhoff.com/english.php?content=../content/1033/tc3_overview/9309844363.html&amp;id=">対応するネットワークコントローラの一覧</a>を確認すること.</p>
<blockquote>
<p>Note: 或いは, TwinCATのインストール後に, <code>C:/TwinCAT/3.1/Driver/System/TcI8254x.inf</code>に対応するデバイスのVendor IDとDevice IDが書かれているので,「デバイスマネージャー」→「イーサネットアダプタ」→「プロパティ」→「詳細」→「ハードウェアID」と照らし合わせることでも確認できる.</p>
</blockquote>
<p>上記以外のネットワークコントローラでも動作する場合があるが, その場合, 正常な動作とリアルタイム性は保証されない.</p>
<ul>
<li><a href="Users_Manual/link/twincat.html#twincat%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">TwinCATのインストール</a></li>
<li><a href="Users_Manual/link/twincat.html#autd-server">AUTD Server</a>
<ul>
<li><a href="Users_Manual/link/twincat.html#%E5%88%9D%E5%9B%9E%E3%81%AE%E8%BF%BD%E5%8A%A0%E4%BD%9C%E6%A5%AD">初回の追加作業</a></li>
<li><a href="Users_Manual/link/twincat.html#%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9">ライセンス</a></li>
<li><a href="Users_Manual/link/twincat.html#autd-server%E3%81%AE%E5%AE%9F%E8%A1%8C">AUTD Serverの実行</a></li>
</ul>
</li>
<li><a href="Users_Manual/link/twincat.html#twincat%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AEapi">TwinCATリンクのAPI</a>
<ul>
<li><a href="Users_Manual/link/twincat.html#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF">コンストラクタ</a></li>
</ul>
</li>
<li><a href="Users_Manual/link/twincat.html#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">トラブルシューティング</a></li>
<li><a href="Users_Manual/link/twincat.html#remotetwincat">RemoteTwinCAT</a>
<ul>
<li><a href="Users_Manual/link/twincat.html#%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97">セットアップ</a></li>
<li><a href="Users_Manual/link/twincat.html#remotetwincat%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AEapi">RemoteTwinCATリンクのAPI</a>
<ul>
<li><a href="Users_Manual/link/twincat.html#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF-1">コンストラクタ</a></li>
</ul>
</li>
<li><a href="Users_Manual/link/twincat.html#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB">ファイアウォール</a></li>
</ul>
</li>
</ul>
<h2 id="twincatのインストール"><a class="header" href="#twincatのインストール">TwinCATのインストール</a></h2>
<p>前提として, TwinCATはHyper-VやVirtual Machine Platformと共存できない.
そのため, これらの機能を無効にする必要がある.
これには, 例えば, PowerShellを管理者権限で起動し,</p>
<pre><code class="language-PowerShell">Disable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-Hypervisor
Disable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
</code></pre>
<p>と打ち込めば良い.</p>
<p>また, Windows 11の場合, 仮想化ベースのセキュリティ機能もオフにする必要がある.
「Windows セキュリティ」→ 「デバイス セキュリティ」→「コア分離」→「メモリ整合性」をオフにする.</p>
<p>まず, TwinCAT XAEを<a href="https://www.beckhoff.com/en-en/">公式サイト</a>からダウンロードする.
ダウンロードには登録 (無料) が必要になる.</p>
<p>ダウンロードしたインストーラを起動し, 指示に従う.
<strong>この時, TwinCAT XAE Shell installにチェックを入れ, Visual Studio Integrationのチェックを外すこと.</strong></p>
<p>インストール後に再起動し, <code>C:/TwinCAT/3.1/System/win8settick.bat</code>を管理者権限で実行し, 再び再起動する.</p>
<h2 id="autd-server"><a class="header" href="#autd-server">AUTD Server</a></h2>
<p>TwinCATのLinkを使うには, まず, <code>AUTD Server</code>をインストールする必要がある.
<a href="https://github.com/shinolab/autd3/releases">GitHub Releases</a>にてインストーラを配布しているので, これをダウンロードし, 指示に従ってインストールする.</p>
<blockquote>
<p>NOTE
必ず, 使用するソフトウェアのバージョンに合わせた<code>AUTD Server</code>を使用すること.</p>
</blockquote>
<p><code>AUTD Server</code>を実行すると, 以下のような画面になるので, <code>TwinCAT</code>タブを開く.</p>
<figure>
  <img src="Users_Manual/link/../../fig/Users_Manual/autdserver_twincat.jpg"/>
</figure>
<h3 id="初回の追加作業"><a class="header" href="#初回の追加作業">初回の追加作業</a></h3>
<p>初回のみ, 以下の作業が必要になる.</p>
<p>まず, 「Copy AUTD.xml」ボタンを押す.
ここで, 「AUTD.xml is successfully copied」のようなメッセージが出れば成功である.</p>
<p>次に, 「Open XAE Shell」ボタンを押し, XAE Shellを開く.
TwinCAT XAE Shell上部メニューから「TwinCAT」→「Show Realtime Ethernet Compatible Devices」を開き「Compatible devices」の中の対応デバイスを選択し, Installをクリックする.
「Installed and ready to use devices (realtime capable)」にインストールされたアダプタが表示されていれば成功である.</p>
<p>なお,「Compatible devices」に何も表示されていない場合はそのPCのイーサネットデバイスはTwinCATに対応していない.
「Incompatible devices」の中のドライバもインストール自体は可能で, インストールすると「Installed and ready to use devices (for demo use only)」と表示される.
この場合, 使用できるが動作保証はない.</p>
<h3 id="ライセンス"><a class="header" href="#ライセンス">ライセンス</a></h3>
<p>また, 初回はライセンス関係のエラーが出るので, XAE Shellで「Solution Explorer」→「SYSTEM」→「License」を開き, 「7 Days Trial License …」をクリックし, 画面に表示される文字を入力する.
なお. ライセンスは7日間限定のトライアルライセンスだが, 切れたら再び同じ作業を行うことで再発行できる.
ライセンスを発行し終わったら, TwinCAT XAE Shellを閉じて, 再び実行する.</p>
<h3 id="autd-serverの実行"><a class="header" href="#autd-serverの実行">AUTD Serverの実行</a></h3>
<p>AUTD3とPCを接続し, AUTD3の電源が入った状態で, 「Run」ボタンを押す.
このとき, 「Client IP address」の欄は空白にしておくこと.</p>
<p>下の画面のように, AUTD3デバイスが見つかった旨のメッセージが出れば成功である.</p>
<figure>
  <img src="Users_Manual/link/../../fig/Users_Manual/autdserver_twincat_run.jpg"/>
</figure>
<p>なお, AUTD ServerはPCの電源を切る, スリープモードに入る等でLinkが途切れるので, その都度実行し直すこと.</p>
<h2 id="twincatリンクのapi"><a class="header" href="#twincatリンクのapi">TwinCATリンクのAPI</a></h2>
<h3 id="コンストラクタ"><a class="header" href="#コンストラクタ">コンストラクタ</a></h3>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_twincat;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_link_twincat::TwinCAT;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">    .open_with(
</span>TwinCAT::builder()
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/twincat.hpp&quot;

autd3::link::TwinCAT::builder()
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Link;

TwinCAT.Builder()
</code></pre>
<pre><code class="language-python">from pyautd3.link.twincat import TwinCAT

TwinCAT.builder()
</code></pre>
<h2 id="トラブルシューティング"><a class="header" href="#トラブルシューティング">トラブルシューティング</a></h2>
<p>大量のデバイスを使用しようとすると, 下の図のようなエラーが発生することがある.</p>
<figure>
  <img src="Users_Manual/link/../../fig/Users_Manual/tcerror.jpg"/>
  <figcaption>9台のAUTD3デバイスを使用した際のTwinCATエラー</figcaption>
</figure>
<p>この場合は, <code>AUTD Server</code>の<code>Sync0 cycle time</code>と<code>Send task cycle time</code>の値を増やし, AUTD Serverを再び実行する.
これらのオプションの値はデフォルトでそれぞれ<code>2</code>になっている.</p>
<p>どの程度の値にすればいいかは接続する台数による.
エラーが出ない中で可能な限り小さな値が望ましい.
例えば, 9台の場合は3, 4程度の値にしておけば動作するはずである.</p>
<h1 id="remotetwincat"><a class="header" href="#remotetwincat">RemoteTwinCAT</a></h1>
<p>前述の通り, AUTD3とTwinCATを使う場合はWindows OSと特定のネットワークアダプタが必要になる.
Windows以外のPCで開発したい場合は, RemoteTwinCAT linkを用いてLinux/macOSから遠隔でTwinCATを操作することができる.</p>
<h2 id="セットアップ"><a class="header" href="#セットアップ">セットアップ</a></h2>
<p>RemoteTwinCATを使用する場合はPCを2台用意する必要がある.
この時, 片方のPCは上記のTwinCAT linkが使えるである必要がある.
このPCをここでは“サーバ“と呼ぶ.
一方, 開発側のPC, 即ちSDKを使用する側は特に制約はなく, サーバと同じLANに繋がっていれば良い, こちらをここでは“クライアント“と呼ぶ.</p>
<p>まず, サーバとAUTDデバイスを接続する.
この時使うLANのアダプタはTwinCAT linkと同じく, TwinCAT対応のアダプタである必要がある.
また, サーバとクライアントを別のLANで繋ぐ.
こちらのLANアダプタはTwinCAT対応である必要はない<sup class="footnote-reference"><a href="#fn_remote_twin">1</a></sup>.
そして, サーバとクライアント間のLANのIPを確認しておく.
ここでは例えば, サーバ側が<code>172.16.99.104</code>, クライアント側が<code>172.16.99.62</code>だったとする.
次に, サーバで<code>AUTD Server</code>を起動する.
この時, <code>Client IP address</code>にクライアントのIPアドレス (この例だと<code>172.16.99.62</code>) を指定する.</p>
<figure>
  <img src="Users_Manual/link/../../fig/Users_Manual/autdserver_remotetwincat.jpg"/>
</figure>
<p>右側の画面に, 「Server AmsNetId」と「Client AmsNetId」が表示されるので, これをメモっておく.</p>
<blockquote>
<p>NOTE: 「Server AmsNetId」の最初の4桁はServerのIPアドレスを意味しているわけではないので注意されたい.</p>
</blockquote>
<h2 id="remotetwincatリンクのapi"><a class="header" href="#remotetwincatリンクのapi">RemoteTwinCATリンクのAPI</a></h2>
<h3 id="コンストラクタ-1"><a class="header" href="#コンストラクタ-1">コンストラクタ</a></h3>
<p>RemoteTwinCATリンクのコンストラクタには「Server AmsNetId」を指定する.</p>
<p>また, <code>with_server_ip</code>と<code>with_client_ams_net_id</code>でサーバーのIPアドレスとクライアントのNetIdを指定する.
これらは省略することも可能だが, 基本的には指定することを推奨する.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_twincat;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_link_twincat::RemoteTwinCAT;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">     .open_with(
</span>RemoteTwinCAT::builder(&quot;172.16.99.111.1.1&quot;)
            .with_server_ip(&quot;172.16.99.104&quot;)
            .with_client_ams_net_id(&quot;172.16.99.62.1.1&quot;)
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/twincat.hpp&quot;

autd3::link::RemoteTwinCAT::builder(&quot;172.16.99.111.1.1&quot;)
    .with_server_ip(&quot;172.16.99.104&quot;)
    .with_client_ams_net_id(&quot;172.16.99.62.1.1&quot;)
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Link;

RemoteTwinCAT.Builder(&quot;172.16.99.111.1.1&quot;)
        .WithServerIp(IPAddress.Parse(&quot;172.16.99.104&quot;))
        .WithClientAmsNetId(&quot;172.16.99.62.1.1&quot;)
</code></pre>
<pre><code class="language-python">from pyautd3.link.twincat import RemoteTwinCAT

RemoteTwinCAT.builder(&quot;172.16.99.111.1.1&quot;)\
    .with_server_ip(&quot;172.16.99.104&quot;)\
    .with_client_ams_net_id(&quot;172.16.99.62.1.1&quot;)
</code></pre>
<h2 id="ファイアウォール"><a class="header" href="#ファイアウォール">ファイアウォール</a></h2>
<p>TCP関係のエラーが出る場合は, ファイアウォールでADSプロトコルがブロックされている可能性がある.
その場合は, ファイアウォールの設定でTCP/UDPの48898番ポートの接続を許可する.</p>
<div class="footnote-definition" id="fn_remote_twin"><sup class="footnote-definition-label">1</sup>
<p>無線LANでも可</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="soem"><a class="header" href="#soem">SOEM</a></h1>
<p><a href="https://github.com/OpenEtherCATsociety/SOEM">SOEM</a>は有志が開発しているオープンソースのEherCAT Masterライブラリである.
TwinCATとは異なり通常のWindows上で動作するためリアルタイム性は保証されない.
そのため, 基本的にTwinCATを使用することを推奨する.
SOEMを使用するのはやむを得ない理由があるか, 開発時のみに限定するべきである.
一方, SOEMはクロスプラットフォームで動作し, インストールも単純という利点がある.</p>
<p>Windowsの場合は, <a href="https://nmap.org/npcap/">npcap</a>を<strong>WinPcap API compatible mode</strong>でインストールしておくこと.
Linux/macOSの場合は, 特に準備は必要ない.</p>
<blockquote>
<p>NOTE: <code>SOEM</code>を使用する場合, <code>Controller</code>をopenしてから10-20秒ほどはEtherCATスレーブ同士の同期が完了していない可能性があるので注意されたい. (この時間は個体差や同期信号/送信サイクルによって変化する.)
この期間, デバイス間の超音波の同期は保証されない.</p>
</blockquote>
<ul>
<li><a href="Users_Manual/link/soem.html#soem%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AEapi">SOEMリンクのAPI</a></li>
<li><a href="Users_Manual/link/soem.html#remotesoem">RemoteSOEM</a>
<ul>
<li><a href="Users_Manual/link/soem.html#autd-server">AUTD Server</a></li>
<li><a href="Users_Manual/link/soem.html#remotesoem%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AEapi">RemoteSOEMリンクのAPI</a></li>
<li><a href="Users_Manual/link/soem.html#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB">ファイアウォール</a></li>
</ul>
</li>
</ul>
<h2 id="soemリンクのapi"><a class="header" href="#soemリンクのapi">SOEMリンクのAPI</a></h2>
<p>SOEMリンクで指定できるオプションは以下の通りである.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_soem;
</span>use autd3::prelude::*;
use autd3_link_soem::{SOEM, SyncMode};

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">           .open_with(
</span>SOEM::builder()
    .with_ifname(&quot;&quot;)
    .with_buf_size(32)
    .with_on_err(|msg| {
        eprintln!(&quot;Unrecoverable error occurred: {msg}&quot;);
    })
    .with_state_check_interval(std::time::Duration::from_millis(100))
    .with_on_lost(|msg| {
        eprintln!(&quot;Unrecoverable error occurred: {msg}&quot;);
        std::process::exit(-1);
    })
    .with_sync0_cycle(2)
    .with_send_cycle(2)
    .with_timer_strategy(TimerStrategy::BusyWait)
    .with_sync_mode(SyncMode::DC)
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/soem.hpp&quot;

[[noreturn]] void on_lost(const char* msg) {
  std::cerr &lt;&lt; &quot;Link is lost\n&quot; &lt;&lt; msg &lt;&lt; std::endl;
  exit(-1);
}

void on_err(const char* msg) { std::cerr &lt;&lt; &quot;Err: &quot; &lt;&lt; msg &lt;&lt; std::endl; }

autd3::link::SOEM::builder()
    .with_ifname(&quot;&quot;)
    .with_buf_size(32)
    .with_on_err(&amp;on_err)
    .with_state_check_interval(std::chrono::milliseconds(100))
    .with_on_lost(&amp;on_lost)
    .with_sync0_cycle(2)
    .with_send_cycle(2)
    .with_timer_strategy(autd3::TimerStrategy::BusyWait)
    .with_sync_mode(autd3::link::SyncMode::DC)
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Link;

var onLost = new SOEM.OnErrCallbackDelegate(msg =&gt;
{
    Console.WriteLine($&quot;Unrecoverable error occurred: {msg}&quot;);
    Environment.Exit(-1);
});
var onErr = new SOEM.OnErrCallbackDelegate(msg =&gt;
{
    Console.WriteLine($&quot;Err: {msg}&quot;);
});

SOEM.Builder()
    .WithIfname(&quot;&quot;)
    .WithBufSize(32)
    .WithOnErr(onErr)
    .WithStateCheckInterval(TimeSpan.FromMilliseconds(100))
    .WithOnLost(onLost)
    .WithSync0Cycle(2)
    .WithSendCycle(2)
    .WithTimerStrategy(TimerStrategy.BusyWait)
    .WithSyncMode(SyncMode.DC)
</code></pre>
<pre><code class="language-python">import ctypes
import os
from datetime import timedelta
from typing import NoReturn

from pyautd3 import TimerStrategy
from pyautd3.link.soem import SOEM, OnErrFunc, SyncMode


def on_lost(msg: ctypes.c_char_p) -&gt; NoReturn:
    print(msg.decode(&quot;utf-8&quot;), end=&quot;&quot;)
    os._exit(-1)


def on_err(msg: ctypes.c_char_p) -&gt; None:
    print(msg.decode(&quot;utf-8&quot;), end=&quot;&quot;)


on_lost_func = OnErrFunc(on_lost)
on_err_func = OnErrFunc(on_err)
SOEM.builder()\
        .with_ifname(&quot;&quot;)\
        .with_buf_size(32)\
        .with_on_err(on_err_func)\
        .with_state_check_interval(timedelta(milliseconds=100))\
        .with_on_lost(on_lost_func)\
        .with_sync0_cycle(2)\
        .with_send_cycle(2)\
        .with_timer_strategy(TimerStrategy.BusyWait)\
        .with_sync_mode(SyncMode.DC)
</code></pre>
<ul>
<li><code>ifname</code>: ネットワークインタフェース名. デフォルトでは空白であり, 空白の場合はAUTD3デバイスが接続されているネットワークインタフェースを自動的に選択する.</li>
<li><code>buf_size</code>: 送信キューバッファサイズ. 通常は変更する必要はない.</li>
<li><code>on_err</code>: 何らかのエラーが発生したときのコールバック. コールバック関数はエラーメッセージを引数に取る.</li>
<li><code>state_check_interval</code>: エラーが出ているかどうかを確認する間隔. デフォルトは<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">100</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">ms</span></span></span></span></span></span>.</li>
<li><code>on_lost</code>: 回復不能なエラー (例えば, ケーブルが抜けるなど) が発生したときのコールバック<sup class="footnote-reference"><a href="#fn_soem_err">1</a></sup>. コールバック関数はエラーメッセージを引数に取る.</li>
<li><code>sync0_cycle</code>: 同期信号の周期. デフォルトは2 (単位は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">500</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">us</span></span></span></span></span></span>).</li>
<li><code>send_cycle</code>: 送信サイクル. デフォルトは2 (単位は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">500</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">us</span></span></span></span></span></span>).
<ul>
<li><code>SOEM</code>も大量のデバイスを接続すると挙動が不安定になる場合がある<sup class="footnote-reference"><a href="#fn_soem">2</a></sup>. このときは, <code>sync0_cycle</code>と<code>send_cycle</code>の値を増やす. これら値はエラーが出ない中で, 可能な限り小さな値が望ましい. デフォルトは2であり, どの程度の値にすべきかは接続している台数に依存する. 例えば, 9台の場合は3, 4程度の値にしておけば動作するはずである.</li>
</ul>
</li>
<li><code>timer_strategy</code>: タイマーの戦略. デフォルトは<code>Sleep</code>である.
<ul>
<li><code>Sleep</code>       : 標準ライブラリのsleepを用いる</li>
<li><code>BusyWait</code>    : ビジーウェイトを用いる. 高解像度だが, CPU負荷が高い.</li>
<li><code>NativeTimer</code> : OSのタイマー機能を用いる
<ul>
<li>WindowsではTimerQueueTimer, linuxではPOSIXタイマー, macOSではGrand Central Dispatch Timer</li>
</ul>
</li>
</ul>
</li>
<li><code>sync_mode</code>: 同期モード. 詳細は<a href="https://infosys.beckhoff.com/english.php?content=../content/1033/ethercatsystem/2469122443.html&amp;id=">Beckhoffの説明</a>を参照されたい.</li>
</ul>
<h1 id="remotesoem"><a class="header" href="#remotesoem">RemoteSOEM</a></h1>
<p>このLinkは<code>SOEM</code>を動かすサーバーPCとユーザプログラムを動かすクライアントPCを分離するためのものである.</p>
<p><code>RemoteSOEM</code>を使用する場合はPCを2台用意する必要がある.
この時, 片方のPCは<code>SOEM</code> linkが使えるである必要がある.
このPCをここでは“サーバ“と呼ぶ.
一方, 開発側のPC, 即ちSDKを使用する側は特に制約はなく, サーバと同じLANに繋がっていれば良い, こちらをここでは“クライアント“と呼ぶ.</p>
<p>まず, サーバとAUTDデバイスを接続する.
また, サーバとクライアントを別のLANで繋ぐ<sup class="footnote-reference"><a href="#fn_remote_soem">3</a></sup>.
そして, サーバとクライアント間のLANのIPを確認しておく.
ここでは例えば, サーバ側が<code>172.16.99.104</code>, クライアント側が<code>172.16.99.62</code>だったとする.</p>
<h2 id="autd-server-1"><a class="header" href="#autd-server-1">AUTD Server</a></h2>
<p><code>RemoteSOEM</code>を使用する場合, サーバに<code>AUTD Server</code>をインストールする必要がある.
<a href="https://github.com/shinolab/autd3/releases">GitHub Releases</a>にてインストーラを配布しているので, これをダウンロードし, 指示に従ってインストールする.</p>
<p><code>AUTD Server</code>を実行すると, 以下のような画面になるので, <code>SOEM</code>タブを開く.</p>
<figure>
  <img src="Users_Manual/link/../../fig/Users_Manual/autdserver_remotesoem.jpg"/>
</figure>
<p>ポートに適当なポート番号を指定し, <code>Run</code>ボタンを押す.</p>
<p>AUTD3デバイスが見つかり, クライアントとの接続待ちである旨のメッセージが表示されれば成功である.</p>
<p>なお, <code>AUTD Server</code>では<code>SOEM</code>と同等のオプションを指定できる.</p>
<h2 id="remotesoemリンクのapi"><a class="header" href="#remotesoemリンクのapi">RemoteSOEMリンクのAPI</a></h2>
<p><code>RemoteSOEM</code>のコンストラクタでは, &lt;サーバのIP:ポート&gt;を指定する.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_soem;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_link_soem::RemoteSOEM;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">    .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">           .open_with(
</span>RemoteSOEM::builder(&quot;172.16.99.104:8080&quot;.parse()?)
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/soem.hpp&quot;

autd3::link::RemoteSOEM::builder(&quot;172.16.99.104:8080&quot;)
</code></pre>
<pre><code class="language-cs">using System.Net;
using AUTD3Sharp.Link;

RemoteSOEM.Builder(new IPEndPoint(IPAddress.Parse(&quot;172.16.99.104&quot;), 8080))
</code></pre>
<pre><code class="language-python">from pyautd3.link.soem import RemoteSOEM

RemoteSOEM.builder(&quot;172.16.99.104:8080&quot;)
</code></pre>
<h2 id="ファイアウォール-1"><a class="header" href="#ファイアウォール-1">ファイアウォール</a></h2>
<p>TCP関係のエラーが出る場合は, ファイアウォールでブロックされている可能性がある.
その場合は, ファイアウォールの設定でTCP/UDPの指定したポートの接続を許可する.</p>
<div class="footnote-definition" id="fn_soem_err"><sup class="footnote-definition-label">1</sup>
<p>なお, 回復不能なので直ちに終了するくらいしかできることはない.</p>
</div>
<div class="footnote-definition" id="fn_soem"><sup class="footnote-definition-label">2</sup>
<p>TwinCATよりは緩く, 普通に動くこともある.</p>
</div>
<div class="footnote-definition" id="fn_remote_soem"><sup class="footnote-definition-label">3</sup>
<p>無線LANでも可</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="simulator"><a class="header" href="#simulator">Simulator</a></h1>
<p>Simulator linkは<a href="Users_Manual/link/../../Simulator/simulator.html">AUTDシミュレータ</a>を使用する際に使うLinkである.</p>
<p>このlinkの使用の前に, AUTDシミュレータを起動しておく必要がある.</p>
<ul>
<li><a href="Users_Manual/link/simulator.html#simulator%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AEapi">SimulatorリンクのAPI</a>
<ul>
<li><a href="Users_Manual/link/simulator.html#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF">コンストラクタ</a></li>
<li><a href="Users_Manual/link/simulator.html#%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E6%8E%A5%E7%B6%9A">リモート接続</a></li>
<li><a href="Users_Manual/link/simulator.html#geometry%E3%81%AE%E6%9B%B4%E6%96%B0"><code>Geometry</code>の更新</a></li>
</ul>
</li>
</ul>
<h2 id="simulatorリンクのapi"><a class="header" href="#simulatorリンクのapi">SimulatorリンクのAPI</a></h2>
<h3 id="コンストラクタ-2"><a class="header" href="#コンストラクタ-2">コンストラクタ</a></h3>
<p><code>Simulator</code>のコンストラクタにはAUTDシミュレータのポート番号を指定する.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_simulator;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_link_simulator::Simulator;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">            .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">            .open_with(
</span>Simulator::builder(8080)
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/simulator.hpp&quot;

autd3::link::Simulator::builder(8080)
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Link;

Simulator.Builder(8080)
</code></pre>
<pre><code class="language-python">from pyautd3.link.simulator import Simulator

Simulator.builder(8080)
</code></pre>
<h3 id="リモート接続"><a class="header" href="#リモート接続">リモート接続</a></h3>
<p><code>with_server_ip</code>でAUTDシミュレータを実行しているサーバのIPアドレスを指定することで, リモートのシミュレータに接続することができる.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_simulator;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_link_simulator::Simulator;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::builder()
</span><span class="boring">            .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">            .open_with(
</span>Simulator::builder(8080).with_server_ip(&quot;127.0.0.1&quot;.parse()?)
<span class="boring">).await?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/link/simulator.hpp&quot;

autd3::link::Simulator::builder(8080).with_server_ip(&quot;127.0.0.1&quot;)
</code></pre>
<pre><code class="language-cs">using System.Net;
using AUTD3Sharp.Link;

Simulator.Builder(8080).WithServerIp(IPAddress.Parse(&quot;127.0.0.1&quot;))
</code></pre>
<pre><code class="language-python">from pyautd3.link.simulator import Simulator

Simulator.builder(8080).with_server_ip(&quot;127.0.0.1&quot;)
</code></pre>
<p>デフォルトはローカルホスト (“127.0.0.1”) である.</p>
<h3 id="geometryの更新"><a class="header" href="#geometryの更新"><code>Geometry</code>の更新</a></h3>
<p><code>Geometry</code>を更新しても, Simulator側の表示は自動的には更新されない.
<code>Geometry</code>を更新するには<code>update_geometry</code>関数を使用する.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_link_simulator;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">use autd3_link_simulator::Simulator;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder()
</span><span class="boring">            .add_device(AUTD3::new(Vector3::zeros()))
</span><span class="boring">            .open_with(Simulator::builder(8080)).await?;
</span>autd.link.update_geometry(&amp;autd.geometry).await?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">autd.link.update_geometry_async(autd.geometry()).get();
</code></pre>
<pre><code class="language-cs">await autd.Link.UpdateGeometryAsync(autd.Geometry);
</code></pre>
<pre><code class="language-python">await autd.link.update_geometry_async(autd.geometry)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="gain"><a class="header" href="#gain">Gain</a></h1>
<p>AUTDは各振動子の位相/振幅を個別に制御することができ, これによって様々な音場を生成できる.
<code>Gain</code>はこれを管理するクラスであり, SDKにはデフォルトでいくつかの種類の音場を生成するための<code>Gain</code>がデフォルトでいくつか用意されている.</p>
<ul>
<li><a href="Users_Manual/./gain/null.html">Null</a></li>
<li><a href="Users_Manual/./gain/focus.html">Focus</a></li>
<li><a href="Users_Manual/./gain/bessel.html">Bessel</a></li>
<li><a href="Users_Manual/./gain/plane.html">Plane</a></li>
<li><a href="Users_Manual/./gain/uniform.html">Uniform</a></li>
<li><a href="Users_Manual/./gain/grouped.html">Group</a></li>
<li><a href="Users_Manual/./gain/holo.html">Holo</a></li>
<li><a href="Users_Manual/./gain/cache.html">Cache</a></li>
<li><a href="Users_Manual/./gain/transform.html">Transform</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="null"><a class="header" href="#null">Null</a></h1>
<p><code>Null</code>は振幅0の<code>Gain</code>である.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let g = autd3::gain::Null::new();
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto g = autd3::gain::Null();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain;

var g = new Null();
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Null

g = Null()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="focus"><a class="header" href="#focus">Focus</a></h1>
<p><code>Focus</code>は最も単純な<code>Gain</code>であり, 単一焦点を生成する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span>let g = autd3::gain::Focus::new(Vector3::new(x, y, z));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g = autd3::gain::Focus(autd3::Vector3(x, y, z));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Focus(new Vector3d(x, y, z));
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Focus

g = Focus([x, y, z])
</code></pre>
<h2 id="振幅の指定"><a class="header" href="#振幅の指定">振幅の指定</a></h2>
<p><code>with_intensity</code>にて, 出力振幅を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span>let g = autd3::gain::Focus::new(Vector3::new(x, y, z))
            .with_intensity(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g = autd3::gain::Focus(autd3::Vector3(x, y, z))
                   .with_intensity(autd3::EmitIntensity::maximum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Focus(new Vector3d(x, y, z)).WithIntensity(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.gain import Focus

g = Focus([x, y, z]).with_intensity(EmitIntensity.maximum())
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="bessel"><a class="header" href="#bessel">Bessel</a></h1>
<p><code>Bessel</code>ではBessel beamを生成する.
この<code>Gain</code>は長谷川らの論文<sup class="footnote-reference"><a href="#hasegawa2017">1</a></sup>に基づく.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span><span class="boring">let nx = 0.;
</span><span class="boring">let ny = 0.;
</span><span class="boring">let nz = 0.;
</span><span class="boring">let theta = 0.;
</span>let g = autd3::gain::Bessel::new(
            Vector3::new(x, y, z), 
            Vector3::new(nx, ny, nz), 
            theta,
        );
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g = autd3::gain::Bessel(autd3::Vector3(x, y, z),
                                   autd3::Vector3(nx, ny, nz), theta);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Bessel(
            new Vector3d(x, y, z),
            new Vector3d(nx, ny, nz),
            theta
        );
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Bessel

g = Bessel([x, y, z], [nx, ny, nz], theta)
</code></pre>
<p>コンストラクタの第1引数はビームを生成する仮想円錐の頂点であり, 第2引数はビームの方向, 第3引数はビームに垂直な面とビームを生成する仮想円錐の側面となす角度である (下図の<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>).</p>
<figure>
  <img src="Users_Manual/gain/../../fig/Users_Manual/1.4985159.figures.online.f1.jpg"/>
  <figcaption>Bessel beam (長谷川らの論文より引用)</figcaption>
</figure>
<h2 id="振幅の指定-1"><a class="header" href="#振幅の指定-1">振幅の指定</a></h2>
<p><code>with_intensity</code>にて, 出力振幅を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span><span class="boring">let nx = 0.;
</span><span class="boring">let ny = 0.;
</span><span class="boring">let nz = 0.;
</span><span class="boring">let theta = 0.;
</span>let g = autd3::gain::Bessel::new(
            Vector3::new(x, y, z),
            Vector3::new(nx, ny, nz), 
            theta
        ).with_intensity(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g = autd3::gain::Bessel(autd3::Vector3(x, y, z),
                                   autd3::Vector3(nx, ny, nz), theta)
                   .with_intensity(autd3::EmitIntensity::maximum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Bessel(
            new Vector3d(x, y, z),
            new Vector3d(nx, ny, nz),
            theta
        ).WithIntensity(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.gain import Bessel

g = Bessel([x, y, z], [nx, ny, nz], theta).with_intensity(EmitIntensity.maximum())
</code></pre>
<div class="footnote-definition" id="hasegawa2017"><sup class="footnote-definition-label">1</sup>
<p>Hasegawa, Keisuke, et al. “Electronically steerable ultrasound-driven long narrow air stream.” Applied Physics Letters 111.6 (2017): 064104.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="plane"><a class="header" href="#plane">Plane</a></h1>
<p><code>Plane</code>は平面波を出力する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span><span class="boring">let nx = 0.;
</span><span class="boring">let ny = 0.;
</span><span class="boring">let nz = 0.;
</span><span class="boring">let theta = 0.;
</span>let g = autd3::gain::Plane::new(Vector3::new(nx, ny, nz));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto g = autd3::gain::Plane(autd3::Vector3(nx, ny, nz));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Plane(new Vector3d(nx, ny, nz));
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Plane

g = Plane([nx, ny, nz])
</code></pre>
<p>コンストラクタには平面波の進行方向を指定する.</p>
<h2 id="振幅の指定-2"><a class="header" href="#振幅の指定-2">振幅の指定</a></h2>
<p><code>with_intensity</code>にて, 出力振幅を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span><span class="boring">let nx = 0.;
</span><span class="boring">let ny = 0.;
</span><span class="boring">let nz = 0.;
</span><span class="boring">let theta = 0.;
</span>let g = autd3::gain::Plane::new(Vector3::new(nx, ny, nz)).with_intensity(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto g = autd3::gain::Plane(autd3::Vector3(nx, ny, nz))
             .with_intensity(autd3::EmitIntensity::maximum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Plane(new Vector3d(nx, ny, nz)).WithIntensity(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.gain import Plane

g = Plane([nx, ny, nz]).with_intensity(EmitIntensity.maximum())
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="uniform"><a class="header" href="#uniform">Uniform</a></h1>
<p><code>Uniform</code>はすべての振動子に同じ位相/振幅を設定する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let g = autd3::gain::Uniform::new(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto g = autd3::gain::Uniform(autd3::EmitIntensity::maximum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Gain;

var g = new Uniform(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.gain import Uniform

g = Uniform(EmitIntensity.maximum())
</code></pre>
<p>コンストラクタには振幅を指定する.</p>
<h2 id="位相の指定"><a class="header" href="#位相の指定">位相の指定</a></h2>
<p><code>with_phase</code>にて, 位相を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let g = autd3::gain::Uniform::new(EmitIntensity::MAX).with_phase(Phase::new(0));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto g = autd3::gain::Uniform(autd3::EmitIntensity::maximum())
                   .with_phase(autd3::Phase(0));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain;

var g = new Uniform(EmitIntensity.Max).WithPhase(new Phase(0));
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity, Phase
from pyautd3.gain import Uniform

g = Uniform(EmitIntensity.maximum()).with_phase(Phase(0))
</code></pre>
<p>デフォルトの位相は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>である.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="group"><a class="header" href="#group">Group</a></h1>
<p><code>Group</code>は振動子ごとに別々の<code>Gain</code>を使用するための<code>Gain</code>である.</p>
<p><code>Group</code>では, デバイスと振動子に対してキーを割り当て, その各キーに<code>Gain</code>を紐付けて使用する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span>let g = Group::new(|dev, tr| match tr.idx() {
                0..=100 =&gt; Some(&quot;null&quot;),
                101.. =&gt; Some(&quot;focus&quot;),
                _ =&gt; None,
            })
            .set(&quot;null&quot;, Null::new())
            .set(&quot;focus&quot;, Focus::new(Vector3::new(x, y, z)));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g =
    autd3::gain::Group(
        [](const autd3::Device&amp; dev,
           const autd3::Transducer&amp; tr) -&gt; std::optional&lt;const char*&gt; {
          if (tr.idx() &lt;= 100) return &quot;null&quot;;
          return &quot;focus&quot;;
        })
        .set(&quot;null&quot;, autd3::gain::Null())
        .set(&quot;focus&quot;, autd3::gain::Focus(autd3::Vector3(x, y, z)));
</code></pre>
<ul>
<li>C++の場合, キーには<code>std::optional</code>を使用する必要がある.</li>
</ul>
<pre><code class="language-cs">using AUTD3Sharp.Utils;
using AUTD3Sharp.Gain;

var g = new Group((dev, tr) =&gt; tr.Idx &lt;= 100 ? &quot;null&quot; : &quot;focus&quot;)
          .Set(&quot;null&quot;, new Null())
          .Set(&quot;focus&quot;, new Focus(new Vector3d(x, y, z)));
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Focus, Group, Null

g = (
    Group(lambda _, tr: &quot;null&quot; if tr.idx &lt;= 100 else &quot;focus&quot;)
    .set_gain(&quot;null&quot;, Null())
    .set_gain(&quot;focus&quot;, Focus([x, y, z]))
)
</code></pre>
<p>上の場合は, ローカルインデックスが<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>から<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span>の振動子は<code>Null</code>を, それ以外の振動子は<code>Focus</code>を出力する.</p>
<blockquote>
<p>NOTE:
このサンプルでは, キーとして文字列を使用しているが, HashMapのキーとして使用できるものなら何でも良い.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="holo"><a class="header" href="#holo">Holo</a></h1>
<p><code>Holo</code>は多焦点を生成するための<code>Gain</code>である.
多焦点を生成するアルゴリズムが幾つか提案されており, SDKには以下のアルゴリズムが実装されている.</p>
<ul>
<li><code>SDP</code> - Semidefinite programming, 井上らの論文<sup class="footnote-reference"><a href="#inoue2015">1</a></sup>に基づく</li>
<li><code>LSS</code> - Linear Synthesis Scheme 単一焦点解の重ね合わせ</li>
<li><code>GS</code> - Gershberg-Saxon, Marzoらの論文<sup class="footnote-reference"><a href="#marzo2019">2</a></sup>に基づく</li>
<li><code>GSPAT</code> - Gershberg-Saxon for Phased Arrays of Transducers, Plasenciaらの論文<sup class="footnote-reference"><a href="#plasencia2020">3</a></sup>に基づく</li>
<li><code>LM</code> - Levenberg-Marquardt, LM法はLevenberg<sup class="footnote-reference"><a href="#levenberg1944">4</a></sup>とMarquardt<sup class="footnote-reference"><a href="#marquardt1963">5</a></sup>で提案された非線形最小二乗問題の最適化法, 実装はMadsenのテキスト<sup class="footnote-reference"><a href="#madsen2004">6</a></sup>に基づく.</li>
<li><code>Greedy</code> - Greedy algorithm and Brute-force search, 鈴木らの論文<sup class="footnote-reference"><a href="#suzuki2021">7</a></sup>に基づく</li>
</ul>
<p>また, 各手法は計算Backendを選べるようになっている.
SDKには以下の<code>Backend</code>が用意されている</p>
<ul>
<li><code>NalgebraBackend</code> - <a href="hthttps://nalgebra.org/">Nalgebra</a>を使用</li>
<li><code>CUDABackend</code> - CUDAを使用, GPUで実行</li>
<li><code>ArrayFireBackend</code> - <a href="https://arrayfire.com/">ArrayFire</a>を使用</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate autd3_gain_holo;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_gain_holo::{LinAlgBackend, NalgebraBackend, GSPAT, Pascal};

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let x1 = 0.;
</span><span class="boring">let y1 = 0.;
</span><span class="boring">let z1 = 0.;
</span><span class="boring">let x2 = 0.;
</span><span class="boring">let y2 = 0.;
</span><span class="boring">let z2 = 0.;
</span>let backend = NalgebraBackend::new()?;
let g = GSPAT::new(backend)
      .add_focus(Vector3::new(x1, y1, z1), 5e3 * Pascal)
      .add_focus(Vector3::new(x2, y2, z2), 5e3 * Pascal);
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/gain/holo.hpp&quot;

using autd3::gain::holo::Pascal;
const auto backend = std::make_shared&lt;autd3::gain::holo::NalgebraBackend&gt;();
auto g = autd3::gain::holo::GSPAT(backend)
             .add_focus(autd3::Vector3(x1, y1, z1), 5e3 * Pascal)
             .add_focus(autd3::Vector3(x2, y2, z2), 5e3 * Pascal);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain.Holo;
using AUTD3Sharp.Utils;
using static AUTD3Sharp.Gain.Holo.Amplitude.Units;

var backend = new NalgebraBackend();
var g = new GSPAT&lt;NalgebraBackend&gt;(backend)
            .AddFocus(new Vector3d(x1, y1, z1), 5e3 * Pascal)
            .AddFocus(new Vector3d(x2, y2, z2), 5e3 * Pascal);
</code></pre>
<pre><code class="language-python">from pyautd3.gain.holo import GSPAT, NalgebraBackend, pascal

backend = NalgebraBackend()
g = (
    GSPAT(backend)
    .add_focus([x1, y1, z1], 5e3 * pascal)
    .add_focus([x2, y2, z2], 5e3 * pascal)
)
</code></pre>
<p>各アルゴリズムのコンストラクタの引数は<code>backend</code>である.
また, <code>add_focus</code>関数により各焦点の位置と音圧を指定する.</p>
<h2 id="振幅制約"><a class="header" href="#振幅制約">振幅制約</a></h2>
<p>各アルゴリズムの計算結果の振幅は最終的に振動子が出力できる範囲に制限する必要がある.
これは<code>with_constraint</code>で制御でき, 以下の4つのいずれかを指定する必要がある.</p>
<ul>
<li>DontCare: 何もケアしない.</li>
<li>Normalize: 振幅の最大値ですべての振動子の振幅を割り, 規格化する.</li>
<li>Uniform: すべての振動子の振幅を指定した値にする.</li>
<li>Clamp: 振幅を指定の範囲にクランプする.</li>
</ul>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate autd3_gain_holo;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3_gain_holo::{LinAlgBackend, NalgebraBackend, GSPAT, EmissionConstraint};

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let x1 = 0.;
</span><span class="boring">let y1 = 0.;
</span><span class="boring">let z1 = 0.;
</span><span class="boring">let x2 = 0.;
</span><span class="boring">let y2 = 0.;
</span><span class="boring">let z2 = 0.;
</span>let backend = NalgebraBackend::new()?;
let g = GSPAT::new(backend)
      .with_constraint(EmissionConstraint::Uniform(EmitIntensity::MAX));
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/gain/holo.hpp&quot;

const auto backend = std::make_shared&lt;autd3::gain::holo::NalgebraBackend&gt;();
auto g = autd3::gain::holo::GSPAT(backend).with_constraint(
    autd3::gain::holo::EmissionConstraint::uniform(
        autd3::EmitIntensity::maximum()));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain.Holo;

var backend = new NalgebraBackend();
var g = new GSPAT&lt;NalgebraBackend&gt;(backend).WithConstraint(new Uniform(EmitIntensity.Max));
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.gain.holo import GSPAT, EmissionConstraint, NalgebraBackend

backend = NalgebraBackend()
g = GSPAT(backend).with_constraint(EmissionConstraint.uniform(EmitIntensity.maximum()))
</code></pre>
<h2 id="最適化パラメータ"><a class="header" href="#最適化パラメータ">最適化パラメータ</a></h2>
<p>各アルゴリズムごとに追加のパラメータが存在する.
これらはすべて<code>with_xxx</code>で指定する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate autd3_gain_holo;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">use autd3_gain_holo::{LinAlgBackend, NalgebraBackend, GSPAT, Pascal};
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let x1 = 0.;
</span><span class="boring">let y1 = 0.;
</span><span class="boring">let z1 = 0.;
</span><span class="boring">let x2 = 0.;
</span><span class="boring">let y2 = 0.;
</span><span class="boring">let z2 = 0.;
</span>let backend = NalgebraBackend::new()?;
let g = GSPAT::new(backend).with_repeat(100);
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/gain/holo.hpp&quot;

const auto backend = std::make_shared&lt;autd3::gain::holo::NalgebraBackend&gt;();
auto g = autd3::gain::holo::GSPAT(backend).with_repeat(100);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain.Holo;

var backend = new NalgebraBackend();
var g = new GSPAT&lt;NalgebraBackend&gt;(backend).WithRepeat(100);
</code></pre>
<pre><code class="language-python">from pyautd3.gain.holo import GSPAT, NalgebraBackend

backend = NalgebraBackend()
g = GSPAT(backend).with_repeat(100)
</code></pre>
<p>各パラメータの詳細はそれぞれの論文を参照されたい.</p>
<div class="footnote-definition" id="inoue2015"><sup class="footnote-definition-label">1</sup>
<p>Inoue, Seki, Yasutoshi Makino, and Hiroyuki Shinoda. “Active touch perception produced by airborne ultrasonic haptic hologram.” 2015 IEEE World Haptics Conference (WHC). IEEE, 2015.</p>
</div>
<div class="footnote-definition" id="marzo2019"><sup class="footnote-definition-label">2</sup>
<p>Marzo, Asier, and Bruce W. Drinkwater. “Holographic acoustic tweezers.” Proceedings of the National Academy of Sciences 116.1 (2019): 84-89.</p>
</div>
<div class="footnote-definition" id="plasencia2020"><sup class="footnote-definition-label">3</sup>
<p>Plasencia, Diego Martinez, et al. “GS-PAT: high-speed multi-point sound-fields for phased arrays of transducers.” ACM Transactions on Graphics (TOG) 39.4 (2020): 138-1.</p>
</div>
<div class="footnote-definition" id="levenberg1944"><sup class="footnote-definition-label">4</sup>
<p>Levenberg, Kenneth. “A method for the solution of certain non-linear problems in least squares.” Quarterly of applied mathematics 2.2 (1944): 164-168.</p>
</div>
<div class="footnote-definition" id="marquardt1963"><sup class="footnote-definition-label">5</sup>
<p>Marquardt, Donald W. “An algorithm for least-squares estimation of nonlinear parameters.” Journal of the society for Industrial and Applied Mathematics 11.2 (1963): 431-441.</p>
</div>
<div class="footnote-definition" id="madsen2004"><sup class="footnote-definition-label">6</sup>
<p>Madsen, Kaj, Hans Bruun Nielsen, and Ole Tingleff. “Methods for non-linear least squares problems.” (2004).</p>
</div>
<div class="footnote-definition" id="suzuki2021"><sup class="footnote-definition-label">7</sup>
<p>Suzuki, Shun, et al. “Radiation Pressure Field Reconstruction for Ultrasound Midair Haptics by Greedy Algorithm with Brute-Force Search.” IEEE Transactions on Haptics (2021).</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="cache"><a class="header" href="#cache">Cache</a></h1>
<p><code>with_cache</code>によって<code>Gain</code>の計算結果をキャッシュする<code>Gain</code>を生成できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let g = Null::new().with_cache();
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">const auto g = autd3::gain::Null().with_cache();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain;

var g = new Null().WithCache();
</code></pre>
<pre><code class="language-python">g = Null().with_cache()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="transform"><a class="header" href="#transform">Transform</a></h1>
<p><code>Transform</code>は<code>Gain</code>になんらかの後処理を適用するための機能である.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span>use autd3::prelude::*;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let g = Uniform::new(EmitIntensity::MAX).with_transform(|dev, tr, d| Drive {
    intensity: EmitIntensity::new(d.intensity.value() / 2),
    phase: Phase::from_rad(d.phase.radian() + PI),
});
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto g =
    autd3::gain::Uniform(autd3::EmitIntensity::maximum())
        .with_transform([](const autd3::Device&amp; dev,
                           const autd3::Transducer&amp; tr,
                           autd3::Drive d) -&gt; autd3::Drive {
          d.intensity = autd3::EmitIntensity(d.intensity.value() / 2);
          d.phase = autd3::Phase::from_rad(d.phase.radian() + autd3::pi);
          return d;
        });
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Gain;

var g = new Uniform(EmitIntensity.Max).WithTransform((dev, tr, d) =&gt;
{
    d.Intensity = new EmitIntensity((byte)(d.Intensity.Value / 2));
    d.Phase = Phase.FromRad(d.Phase.Radian + AUTD3.Pi);
    return d;
});
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3 import Drive, EmitIntensity, Phase
from pyautd3.gain import Uniform

g = Uniform(EmitIntensity.maximum()).with_transform(
    lambda dev, tr, d: Drive(
        Phase.from_rad(d.phase.radian + np.pi), EmitIntensity(d.intensity.value // 2)
    )
)
</code></pre>
<p><code>with_transform</code>の引数は<code>Fn(&amp;Device, &amp;Transducer, &amp;Drive) -&gt; Drive</code>であり, 第1引数はデバイス, 第2引数は振動子, 第3引数は元の振幅/位相データである.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="modulation"><a class="header" href="#modulation">Modulation</a></h1>
<p><code>Modulation</code>はAM変調を制御するための仕組みである.</p>
<p>Modulationは音圧振幅に掛け合わされる.
例えば, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>の<code>Sine</code>変調を印加した場合の音圧振幅は以下のようになり, 音圧振幅の正の部分 (或いは, 負の部分) の包絡線が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>のsin波に従う.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/sine_1k_mod.png"/>
</figure>
<p>なお, 現在, <code>Modulation</code>には以下の制約がある.</p>
<ul>
<li>バッファサイズは最大で65536</li>
<li>Modulationデータは内部で8-bit符号なし整数に変換され, 超音波PWM信号のDuty比と掛け合わされる</li>
<li>サンプリングレートは<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">20.48</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">MHz</span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>で, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>は32-bit符号なし整数であり, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span>以上の値である必要がある</li>
<li>Modulationは自動でループする. 1ループだけ, 等の制御は不可能</li>
<li>Modulationの開始/終了タイミングは制御できない</li>
</ul>
<p>SDKにはデフォルトでいくつかの種類のAMを生成するための<code>Modulation</code>が用意されている.</p>
<ul>
<li><a href="Users_Manual/./modulation/static.html">Static</a></li>
<li><a href="Users_Manual/./modulation/sine.html">Sine</a>
<ul>
<li><a href="Users_Manual/./modulation/fourier.html">Fourier</a></li>
</ul>
</li>
<li><a href="Users_Manual/./modulation/square.html">Square</a></li>
<li><a href="Users_Manual/./modulation/wav.html">Wav</a></li>
<li><a href="Users_Manual/./modulation/rawpcm.html">RawPCM</a></li>
<li><a href="Users_Manual/./modulation/cache.html">Cache</a></li>
<li><a href="Users_Manual/./modulation/radiation.html">RadiationPressure</a></li>
<li><a href="Users_Manual/./modulation/transform.html">Transform</a></li>
</ul>
<h2 id="modulationの共通api"><a class="header" href="#modulationの共通api">Modulationの共通API</a></h2>
<h3 id="sampling設定"><a class="header" href="#sampling設定">Sampling設定</a></h3>
<p><code>sampling_config</code>でサンプリング設定を取得できる.
デフォルトのサンプリング周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>である.</p>
<p>また, 一部の<code>Modulation</code>は<code>with_sampling_config</code>でサンプリングを設定できる.
ただし, <code>Modulation</code>の制約上, 必ずしも指定した設定になるとは限らない.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let m = autd3::modulation::Sine::new(150.)
            .with_sampling_config(SamplingConfiguration::from_frequency(4e3)?);
<span class="boring">Ok(())
</span><span class="boring">} </span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(150);
const auto n = m.size();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Modulation;

var m = new Sine(150).WithSamplingConfig(SamplingConfiguration.FromFrequency(4e3));
</code></pre>
<pre><code class="language-python">from pyautd3 import SamplingConfiguration
from pyautd3.modulation import Sine

m = Sine(150).with_sampling_config(SamplingConfiguration.from_frequency(4e3))
</code></pre>
<h3 id="変調データサイズ"><a class="header" href="#変調データサイズ">変調データサイズ</a></h3>
<p>変調データサイズは以下のように取得する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let m = autd3::modulation::Sine::new(150.);
let n = m.len()?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(150).with_sampling_config(
    autd3::SamplingConfiguration::from_frequency(4e3));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Sine(150);
var n = m.Length;
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Sine

m = Sine(150)
n = len(m)
</code></pre>
<h2 id="modulation-delay"><a class="header" href="#modulation-delay">Modulation Delay</a></h2>
<p>Modulationはすべての振動子に同時に作用し, 伝搬遅延を考慮しない.
そのため, 振動子と焦点位置との間の距離に応じて, 変調がずれる可能性がある.</p>
<p>これを補償するために, 振動子毎にサンプリングするインデックスを遅らせる機能が備わっている.</p>
<p>例えば, 以下のようにすると, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>番目のデバイスの<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>番目の振動子は他のすべての振動子に対して, サンプリングするインデックスが一つ遅れる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().open_with(autd3::link::Nop::builder()).await?;
</span>autd.send(ConfigureModDelay::new(|dev, tr| {
    if dev.idx() == 0 &amp;&amp; tr.idx() == 0 {
        1
    } else {
        0
    }
})).await?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

autd.send(autd3::ConfigureModDelay([](const autd3::Device&amp; dev,
                                      const autd3::Transducer&amp; tr) {
  return dev.idx() == 0 &amp;&amp; tr.idx() == 0 ? 1 : 0;
}));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;

autd.Send(new ConfigureModDelay((dev, tr) =&gt; return dev.Idx == 0 &amp;&amp; tr.Idx == 0 ? 1 : 0));
</code></pre>
<pre><code class="language-python">from pyautd3 import ConfigureModDelay

autd.send(ConfigureModDelay(lambda dev, tr: 1 if dev.idx == 0 and tr.idx == 0 else 0))
</code></pre>
<p>サンプリングされるインデックスに対する遅れであるため, どの程度遅れるかは<code>Modulation</code>のサンプリング周波数に依存する.
<code>mod_delay</code>が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>でサンプリング周波数が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">40</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>の場合は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">25</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">μ</span></span><span class="mord mathrm">s</span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>の場合は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">250</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">μ</span></span><span class="mord mathrm">s</span></span></span></span></span></span>の遅れになる.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="static"><a class="header" href="#static">Static</a></h1>
<p>変調なし.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Static::new();
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Static();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Static();
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Static

m = Static()
</code></pre>
<h2 id="振幅の指定-3"><a class="header" href="#振幅の指定-3">振幅の指定</a></h2>
<p><code>with_intensity</code>にて, 出力振幅を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Static::new().with_intensity(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m =
    autd3::modulation::Static().with_intensity(autd3::EmitIntensity::minimum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Modulation;

var m = new Static().WithIntensity(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.modulation import Static

m = Static().with_intensity(EmitIntensity.maximum())
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sine"><a class="header" href="#sine">Sine</a></h1>
<p>音圧をSin波状に変形するための<code>Modulation</code>.</p>
<p>コンストラクタには周波数<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>を整数で指定する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Sine::new(150.);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(150);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Sine(150);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Sine

m = Sine(150)
</code></pre>
<h2 id="振幅とオフセットの指定"><a class="header" href="#振幅とオフセットの指定">振幅とオフセットの指定</a></h2>
<p><code>Sine</code>は音圧の波形が
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span></span></span></span></span>
となるようなAMをかける.
ここで, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span></span></span></span>と<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span></span></span></span>はそれぞれ, <code>with_intensity</code>と<code>with_offset</code>にて指定できる (デフォルトはそれぞれ<code>EmitIntensity::MAX</code>, <code>EmitIntensity::MAX/2</code>).</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Sine::new(150.)
            .with_intensity(EmitIntensity::MAX)
            .with_offset(EmitIntensity::MAX / 2);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(150)
                   .with_intensity(autd3::EmitIntensity::maximum())
                   .with_offset(autd3::EmitIntensity::maximum() / 2);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Sine(150)
        .WithIntensity(EmitIntensity.Max)
        .WithOffset(EmitIntensity.Max / 2);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.modulation import Sine

m = (
    Sine(150)
    .with_intensity(EmitIntensity.minimum())
    .with_offset(EmitIntensity.minimum() / 2)
)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="fourier"><a class="header" href="#fourier">Fourier</a></h1>
<p>複数の周波数の正弦波を重ね合わせた波形を生成する<code>Modulation</code>.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3::modulation::Fourier;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = Fourier::from(Sine::new(100.))
        .add_component(Sine::new(150.))
        .add_components_from_iter([Sine::new(200.)]);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto m =
    autd3::modulation::Fourier(autd3::modulation::Sine(100))
        .add_component(autd3::modulation::Sine(150))
        .add_components_from_iter(std::vector{autd3::modulation::Sine(200)});
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Fourier(new Sine(100))
        .AddComponent(new Sine(150))
        .AddComponentsFromIter(new[] { new Sine(200) });
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Fourier, Sine

m = Fourier(Sine(100)).add_component(Sine(150)).add_components_from_iter([Sine(200)])
</code></pre>
<p><code>+</code>演算子も定義されている.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3::modulation::Fourier;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m: Fourier = Sine::new(100.) + Sine::new(150.) + Sine::new(200.);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(100) + autd3::modulation::Sine(150) +
               autd3::modulation::Sine(200);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Sine(100) + new Sine(150) + new Sine(200);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Fourier, Sine

m = Fourier(Sine(100)) + Sine(150)
</code></pre>
<h2 id="位相パラメータ"><a class="header" href="#位相パラメータ">位相パラメータ</a></h2>
<p><code>Fourier</code>のために, <code>Sine</code>には位相パラメータを指定する機能がある.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span>use autd3::modulation::Fourier;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m: Fourier = Sine::new(100.) + Sine::new(150.).with_phase(PI / 2.0);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(100) +
               autd3::modulation::Sine(150).with_phase(autd3::pi / 2.0);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Modulation;

var m = new Sine(100) + new Sine(150).WithPhase(AUTD3.Pi / 2.0);
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3.modulation import Fourier, Sine

m = Fourier(Sine(100)) + Sine(150).with_phase(np.pi / 2.0)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="square"><a class="header" href="#square">Square</a></h1>
<p>矩形波状の<code>Modulation</code>.</p>
<p>コンストラクタには周波数<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>を整数で指定する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Square::new(150.);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Square(150);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Square(150);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Square

m = Square(150)
</code></pre>
<h2 id="振幅の指定-4"><a class="header" href="#振幅の指定-4">振幅の指定</a></h2>
<p>Low/Highレベルの振幅はそれぞれ, <code>with_low</code>, <code>with_high</code>で指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Square::new(150.)
            .with_low(EmitIntensity::MIN)
            .with_high(EmitIntensity::MAX);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Square(150)
                   .with_low(autd3::EmitIntensity::minimum())
                   .with_high(autd3::EmitIntensity::maximum());
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Modulation;

var m = new Square(150)
        .WithLow(EmitIntensity.Min)
        .WithHigh(EmitIntensity.Max);
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.modulation import Square

m = Square(150).with_low(EmitIntensity.minimum()).with_high(EmitIntensity.maximum())
</code></pre>
<h2 id="duty比の指定"><a class="header" href="#duty比の指定">Duty比の指定</a></h2>
<p><code>with_duty</code>で矩形波のDuty比を指定できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main()  {
</span>let m = autd3::modulation::Square::new(150.)
        .with_duty(0.5);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Square(150).with_duty(0.5);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Square(150).WithDuty(0.5);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Square

m = Square(150).with_duty(0.5)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="wav"><a class="header" href="#wav">Wav</a></h1>
<p><code>Wav</code>はWavファイルをもとに構成される<code>Modulation</code>である.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3_modulation_audio_file;
</span>use autd3_modulation_audio_file::Wav;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let path = &quot;path/to/foo.wav&quot;;
let m = Wav::new(&amp;path)?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/modulation/audio_file.hpp&quot;

const auto path = &quot;path/to/foo.wav&quot;;
const auto m = autd3::modulation::audio_file::Wav(path);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation.AudioFile;

var path = &quot;path/to/foo.wav&quot;;
var m = new Wav(path);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation.audio_file import Wav

path = &quot;path/to/foo.wav&quot;
m = Wav(path)
</code></pre>
<blockquote>
<p>NOTE: <code>Wav</code>では, wavファイルデータをModulationのサンプリング周波数でリサンプリングするので注意されたい.
Modulationのサンプリング周波数の設定と制約は<a href="Users_Manual/modulation/../modulation.html">Modulation</a>を参照されたい.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rawpcm"><a class="header" href="#rawpcm">RawPCM</a></h1>
<p><code>RawPCM</code>はraw pcmファイルをもとに構成される<code>Modulation</code>である.</p>
<pre><code class="language-rust should_panic edition2021"><span class="boring">extern crate autd3_modulation_audio_file;
</span>use autd3_modulation_audio_file::RawPCM;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let path = &quot;path/to/foo.dat&quot;;
let m = RawPCM::new(&amp;path, 4000)?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3/modulation/audio_file.hpp&quot;

const auto path = &quot;path/to/foo.fat&quot;;
const auto m = autd3::modulation::audio_file::RawPCM(path, 4000);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation.AudioFile;

var path = &quot;path/to/foo.dat&quot;;
var m = new RawPCM(path, 4000);
</code></pre>
<pre><code class="language-python">from pyautd3.modulation.audio_file import RawPCM

path = &quot;path/to/foo.dat&quot;
m = RawPCM(path, 4000)
</code></pre>
<p>コンストラクタの第2引数で, このデータのサンプリング周波数を指定する必要がある.</p>
<blockquote>
<p>NOTE: <code>RawPCM</code>では, raw pcmファイルデータをModulationのサンプリング周波数でリサンプリングするので注意されたい.
Modulationのサンプリング周波数の設定と制約は<a href="Users_Manual/modulation/../modulation.html">Modulation</a>を参照されたい.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="cache-1"><a class="header" href="#cache-1">Cache</a></h1>
<p><code>with_cache</code>で計算結果をキャッシュしておくための<code>Modulation</code>を生成できる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let c = Static::new().with_cache()?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Static().with_cache();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Static().WithCache();
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Static

m = Static().with_cache()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="radiationpressure"><a class="header" href="#radiationpressure">RadiationPressure</a></h1>
<p><code>RadiationPressure</code>は<code>Modulation</code>を音圧ではなく, 放射圧 (音圧の二乗に比例) に印加するための<code>Modulation</code>である.</p>
<p>例えば, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>の<code>Sine</code>変調に<code>RadiationPressure</code>を適用した場合の音圧振幅の放射圧は以下のようになり, 放射圧の包絡線が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>のsin波に従う.</p>
<figure>
  <img src="Users_Manual/modulation/../../fig/Users_Manual/sine_1k_mod_rad.png"/>
</figure>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span>use autd3::prelude::*;

<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let m = Sine::new(150.).with_radiation_pressure();
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &lt;autd3.hpp&gt;

const auto m = autd3::modulation::Sine(150).with_radiation_pressure();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Modulation;

var m = new Sine(150).WithRadiationPressure();
</code></pre>
<pre><code class="language-python">from pyautd3.modulation import Sine

m = Sine(150).with_radiation_pressure()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="transform-1"><a class="header" href="#transform-1">Transform</a></h1>
<p><code>Transform</code>は<code>Modulation</code>になんらかの後処理を適用するための機能である.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span>use autd3::prelude::*;
<span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let m = Sine::new(150.).with_transform(|i, d| EmitIntensity::new(d.value() / 2));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto m = autd3::modulation::Sine(150).with_transform(
    [](const size_t idx, const autd3::EmitIntensity d) -&gt; autd3::EmitIntensity {
      return autd3::EmitIntensity(d.value() / 2);
    });
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Modulation;

var m = new Sine(150).WithTransform((i, d) =&gt; new EmitIntensity((byte)(d.Value / 2)));
</code></pre>
<pre><code class="language-python">from pyautd3 import EmitIntensity
from pyautd3.modulation import Sine

m = Sine(150).with_transform(lambda i, d: EmitIntensity(d.value // 2))
</code></pre>
<p><code>with_transform</code>の引数は<code>Fn(usize, EmitIntensity) -&gt; EmitIntensity</code>であり, 第1引数はインデックス, 第2引数は変調データである.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="spatio-temporal-modulation時空間変調"><a class="header" href="#spatio-temporal-modulation時空間変調">Spatio-Temporal Modulation/時空間変調</a></h1>
<p>SDKでは, <code>Gain</code>を周期的に切り替えるための機能 (Spatio-Temporal Modulation, STM) が用意されている.
SDKには単一焦点のみをサポートする<code>FocusSTM</code>と, 任意の<code>Gain</code>をサポートする<code>GainSTM</code>が用意されている.
<code>FocusSTM</code>と<code>GainSTM</code>はAUTD3ハードウェア上のタイマを使用するので時間精度が高いが, 制約も多い.</p>
<ul>
<li><a href="Users_Manual/./stm/focus.html">FocusSTM</a></li>
<li><a href="Users_Manual/./stm/gain.html">GainSTM</a></li>
</ul>
<h2 id="focusstmgainstmの共通api"><a class="header" href="#focusstmgainstmの共通api">FocusSTM/GainSTMの共通API</a></h2>
<h3 id="frequency"><a class="header" href="#frequency">frequency</a></h3>
<p>STMの周波数を取得する.</p>
<h3 id="sampling_config"><a class="header" href="#sampling_config">sampling_config</a></h3>
<p>サンプリング設定を取得する.</p>
<h3 id="start_idxfinish_idx"><a class="header" href="#start_idxfinish_idx">start_idx/finish_idx</a></h3>
<p><code>FocusSTM</code>/<code>GainSTM</code>は通常, 何番目の焦点/<code>Gain</code>からスタートするかは決められていない.
これを指定するには, 以下のように<code>with_start_idx</code>で指定する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let stm = FocusSTM::new(1.0).with_start_idx(Some(0));
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto stm = autd3::FocusSTM(1).with_start_idx(0);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.STM;

var stm = new FocusSTM(1).WithStartIdx(0);
</code></pre>
<pre><code class="language-python">from pyautd3.stm import FocusSTM

stm = FocusSTM(1).with_start_idx(0)
</code></pre>
<p>これにより, <code>start_idx</code>で指定したインデックスの焦点/<code>Gain</code>からスタートするようになる.</p>
<p>また, 同様に, 何番目の焦点/<code>Gain</code>で終了するかは<code>finish_idx</code>で決定できる.</p>
<p>注意点として, <code>finish_idx</code>で指定したインデックスの焦点/<code>Gain</code>は最後に出力されない.
<code>finish_idx</code>の1つ前の焦点/<code>Gain</code>を出力したあと, 終了する.</p>
<p><code>start_idx</code>と<code>finish_idx</code>は, 通常の<code>Gain</code>から<code>FocusSTM</code>/<code>GainSTM</code>への遷移, 及び, <code>FocusSTM</code>/<code>GainSTM</code>から通常の<code>Gain</code>への遷移の場合にのみ有効となる.</p>
<p>これらの設定を無効 (デフォルト) にするには, 以下のようにする.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() {
</span>let stm = FocusSTM::new(1.0).with_start_idx(None);
<span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto stm = autd3::FocusSTM(1).with_start_idx(std::nullopt);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.STM;

var stm = new FocusSTM(1).WithStartIdx(null);
</code></pre>
<pre><code class="language-python">from pyautd3.stm import FocusSTM

stm = FocusSTM(1).with_start_idx(None)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="focusstm"><a class="header" href="#focusstm">FocusSTM</a></h1>
<ul>
<li>最大サンプリング点数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">65536</span></span></span></span>.</li>
<li>サンプリング周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">20.48</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">MHz</span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>.</li>
</ul>
<p><code>FocusSTM</code>の使用方法は以下のようになる.
これは, アレイの中心から直上<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>の点を中心とした半径<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">30</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>の円周上で焦点を回すサンプルである.
円周上を200点サンプリングし, 一周を<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>で回るようにしている. (すなわち, サンプリング周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">200</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>である.)</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().add_device(AUTD3::new(Vector3::zeros())).open_with(autd3::link::Nop::builder()).await?;
</span>let center = autd.geometry.center() + Vector3::new(0., 0., 150.0 * MILLIMETER);
let point_num = 200;
let radius = 30.0 * MILLIMETER;
let stm = FocusSTM::new(1.0).add_foci_from_iter((0..point_num).map(|i| {
    let theta = 2.0 * PI * i as float / point_num as float;
    let p = radius * Vector3::new(theta.cos(), theta.sin(), 0.0);
    center + p
}))?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &lt;ranges&gt;

#include &quot;autd3.hpp&quot;

using namespace std::ranges::views;

const autd3::Vector3 center =
    autd.geometry().center() + autd3::Vector3(0, 0, 150);
const auto points_num = 200;
const auto radius = 30.0;
auto stm = autd3::FocusSTM(1).add_foci_from_iter(
    iota(0) | take(points_num) | transform([&amp;](auto i) {
      const auto theta = 2.0 * autd3::pi * static_cast&lt;double&gt;(i) /
                         static_cast&lt;double&gt;(points_num);
      autd3::Vector3 p = center + autd3::Vector3(radius * std::cos(theta),
                                                 radius * std::sin(theta), 0);
      return p;
    }));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Utils;
using AUTD3Sharp.STM;

var center = autd.Geometry.Center + new Vector3d(0, 0, 150);
const int pointNum = 200;
const double radius = 30.0;
var stm = new FocusSTM(1).AddFociFromIter(Enumerable.Range(0, pointNum).Select(i =&gt;
{
    var theta = 2.0 * Math.PI * i / pointNum;
    return center + radius * new Vector3d(Math.Cos(theta), Math.Sin(theta), 0);
}));
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3.stm import FocusSTM

center = autd.geometry.center + np.array([0.0, 0.0, 150.0])
point_num = 200
radius = 30.0
stm = FocusSTM(1.0).add_foci_from_iter(
    map(
        lambda theta: center + radius * np.array([np.cos(theta), np.sin(theta), 0]),
        map(lambda i: 2.0 * np.pi * i / point_num, range(point_num)),
    )
)
</code></pre>
<p><code>FocusSTM</code>のコンストラクタにはSTM周波数を指定する.
なお, サンプリング点数とサンプリング周期に関する制約によって, 指定した周波数と実際の周波数は異なる可能性がある.
例えば, 上記の例は200点を<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>で回すため, サンプリング周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">200</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">20.48</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">MHz</span></span></span><span class="mord">/102400</span></span></span></span>とすれば良い.
しかし, 例えば<code>point_num=199</code>にすると, サンプリング周波数を<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">199</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>にしなければならないが, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">199</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">20.48</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">MHz</span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>を満たすような整数<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>は存在しない.
そのため, もっとも近い<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>が選択される.
これによって, 指定した周波数と実際の周波数がずれる.
<code>frequency</code>によって実際の周波数を確認することができる.</p>
<h2 id="サンプリング設定の指定"><a class="header" href="#サンプリング設定の指定">サンプリング設定の指定</a></h2>
<p>周波数ではなく, サンプリング周波数等を指定することもできる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let stm = FocusSTM::from_sampling_config(SamplingConfiguration::from_frequency(1.0)?);
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto stm = autd3::FocusSTM::from_sampling_config(
    autd3::SamplingConfiguration::from_frequency(1));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.STM;

var stm = FocusSTM.FromSamplingConfig(SamplingConfiguration.FromFrequency(1));
</code></pre>
<pre><code class="language-python">from pyautd3 import SamplingConfiguration
from pyautd3.stm import FocusSTM

stm = FocusSTM.from_sampling_config(SamplingConfiguration.from_frequency(1))
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="gainstm"><a class="header" href="#gainstm">GainSTM</a></h1>
<p><code>GainSTM</code>は<code>GainSTM</code>とは異なり, 任意の<code>Gain</code>を扱える. ただし, 使用できる<code>Gain</code>の個数は</p>
<ul>
<li>Legacyモードの場合2048</li>
<li>Advanced/AdvancedPhaseモードの場合1024
となる.</li>
</ul>
<p><code>GainSTM</code>の使用方法は以下のようになる.
これは, アレイの中心から直上<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>の点を中心とした半径<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">30</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">mm</span></span></span></span></span></span>の円周上で焦点を回すサンプルである.
円周上を200点サンプリングし, 一周を<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>で回るようにしている. (すなわち, サンプリング周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord">200</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">Hz</span></span></span></span></span></span>である.)</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().open_with(autd3::link::Nop::builder()).await?;
</span>let center = autd.geometry.center() + Vector3::new(0., 0., 150.0 * MILLIMETER);
let point_num = 200;
let radius = 30.0 * MILLIMETER;
let stm = GainSTM::new(1.0).add_gains_from_iter((0..point_num).map(|i| {
    let theta = 2.0 * PI * i as float / point_num as float;
    let p = radius * Vector3::new(theta.cos(), theta.sin(), 0.0);
    Focus::new(center + p)
}))?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &lt;ranges&gt;

#include &quot;autd3.hpp&quot;

using namespace std::ranges::views;

const autd3::Vector3 center =
    autd.geometry().center() + autd3::Vector3(0, 0, 150);
const auto points_num = 200;
const auto radius = 30.0;
auto stm = autd3::GainSTM(1).add_gains_from_iter(
    iota(0) | take(points_num) | transform([&amp;](auto i) {
      const auto theta = 2.0 * autd3::pi * static_cast&lt;double&gt;(i) /
                         static_cast&lt;double&gt;(points_num);
      return autd3::gain::Focus(center +
                                autd3::Vector3(radius * std::cos(theta),
                                               radius * std::sin(theta), 0));
    }));

</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.Utils;
using AUTD3Sharp.STM;
using AUTD3Sharp.Gain;

var center = autd.Geometry.Center + new Vector3d(0, 0, 150);
const int pointNum = 200;
const double radius = 30.0;
var stm = new GainSTM(1.0).AddGainsFromIter(Enumerable.Range(0, pointNum).Select(i =&gt;
{
    var theta = 2.0 * Math.PI * i / pointNum;
    return new Focus(center + radius * new Vector3d(Math.Cos(theta), Math.Sin(theta), 0));
}));
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3.gain import Focus
from pyautd3.stm import GainSTM

center = autd.geometry.center + np.array([0.0, 0.0, 150.0])
point_num = 200
radius = 30.0
stm = GainSTM(1.0).add_gains_from_iter(
    map(
        lambda theta: Focus(
            center + radius * np.array([np.cos(theta), np.sin(theta), 0])
        ),
        map(lambda i: 2.0 * np.pi * i / point_num, range(point_num)),
    )
)
</code></pre>
<h2 id="サンプリング周波数の指定"><a class="header" href="#サンプリング周波数の指定">サンプリング周波数の指定</a></h2>
<p>周波数ではなく, サンプリング周波数を指定することもできる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let stm = GainSTM::from_sampling_config(SamplingConfiguration::from_frequency(1.0)?);
<span class="boring">let stm = stm.add_gain(Null::new())?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto stm = autd3::GainSTM::from_sampling_config(
    autd3::SamplingConfiguration::from_frequency(1));
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.STM;

var stm = GainSTM.FromSamplingConfig(SamplingConfiguration.FromFrequency(1));
</code></pre>
<pre><code class="language-python">from pyautd3 import SamplingConfiguration
from pyautd3.stm import GainSTM

stm = GainSTM.from_sampling_config(SamplingConfiguration.from_frequency(1))
</code></pre>
<h2 id="gainstmmode"><a class="header" href="#gainstmmode">GainSTMMode</a></h2>
<p><code>GainSTM</code>は位相/振幅データをすべて送信するため, レイテンシが大きい<sup class="footnote-reference"><a href="#fn_gain_seq">1</a></sup>.
この問題に対処するため, <code>GainSTM</code>には位相のみを送信して送信にかかる時間を半分にする<code>PhaseFull</code>モードと, 位相を4bitに圧縮して送信時間を4分の1にする<code>PhaseHalf</code>モード<sup class="footnote-reference"><a href="#phase_half">2</a></sup>が用意されている.</p>
<p>このモードの切り替えは<code>with_mode</code>で行う.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span>let stm = GainSTM::new(1.0).with_mode(GainSTMMode::PhaseFull);
<span class="boring">let stm = stm.add_gain(Null::new())?;
</span><span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

auto stm = autd3::GainSTM(1).with_mode(autd3::GainSTMMode::PhaseFull);
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;
using AUTD3Sharp.STM;

var stm = new GainSTM(1).WithMode(GainSTMMode.PhaseFull);
</code></pre>
<pre><code class="language-python">from pyautd3.stm import GainSTM, GainSTMMode

stm = GainSTM(1).with_mode(GainSTMMode.PhaseFull)
</code></pre>
<p>デフォルトはすべての情報を送る<code>PhaseDutyFull</code>モードである.</p>
<div class="footnote-definition" id="fn_gain_seq"><sup class="footnote-definition-label">1</sup>
<p><code>FocusSTM</code>のおよそ75倍のレイテンシ</p>
</div>
<div class="footnote-definition" id="phase_half"><sup class="footnote-definition-label">2</sup>
<p>Legacyモード限定</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="silencer"><a class="header" href="#silencer">Silencer</a></h1>
<p>AUTD3には出力を静音化するためのSilencerが用意されている.
Silencerは, 振動子の駆動信号の急激な変動を抑制し, 静音化する.</p>
<h2 id="理論"><a class="header" href="#理論">理論</a></h2>
<p>詳細は鈴木らの論文<sup class="footnote-reference"><a href="#suzuki2020">1</a></sup>を参照されたい.</p>
<p>大まかに概要を述べると, </p>
<ul>
<li>振幅変調された超音波は可聴音を生じる</li>
<li>超音波振動子を駆動する際に, 位相変化が振幅変動を引き起こす
<ul>
<li>したがって, 可聴音の騒音が生じる</li>
</ul>
</li>
<li>位相変化を線形に補間し, 段階的に変化させることで振幅変動を抑えられる
<ul>
<li>したがって, 騒音を低減できる</li>
</ul>
</li>
<li>補間を細かくやると, その分だけ騒音を小さくできる</li>
</ul>
<p>となる.</p>
<h2 id="silencerの設定"><a class="header" href="#silencerの設定">Silencerの設定</a></h2>
<p>Silencerの設定には<code>Silencer</code>を送信する.</p>
<p><code>Silencer</code>には<code>step</code>を設定できる.
詳細は以下を参照されたいが, 大まかには<code>step</code>を小さくするほどより静かになる.</p>
<p>Silencerはデフォルトで適当な値に設定されている.
Silencerを無効化する場合は, <code>disable</code>を送信する.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let step_intensity = 256;
</span><span class="boring">let step_phase = 256;
</span>let config = Silencer::default();
let config = Silencer::new(step_intensity, step_phase);
let config = Silencer::disable();
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

const auto config = autd3::Silencer();
const auto config = autd3::Silencer(step_intensity, step_phase);
const auto config = autd3::Silencer::disable();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp;

var config = new Silencer();
var config = new Silencer(stepIntensity, stepPhase);
var config = Silencer.Disable;
</code></pre>
<pre><code class="language-python">from pyautd3 import Silencer

config = Silencer()
config = Silencer(step_intensity, step_phase)
config = Silencer.disable()
</code></pre>
<h2 id="silencerによる位相の変化"><a class="header" href="#silencerによる位相の変化">Silencerによる位相の変化</a></h2>
<p>Silencerは位相<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>の変化を線形補間し, 段階的にすることで静音化を行う.
即ち, 位相<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>の時系列データを(単純)移動平均フィルタに通しているのにほとんど等しい.
ただし, 位相データが周期的であるという事を考慮している点で異なる.</p>
<p>例えば, 超音波の周期<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span></span></span></span>の場合を考える. 即ち, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">rad</span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span></span></span></span>が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">rad</span></span></span></span></span>に対応する. 
ここで, 時刻<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>で, 位相が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>から<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span>に変化したとする.
この時, Silencerによる位相変化は以下の図のようになる.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/silent/phase.svg"/>
<figcaption>位相<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>の変化</figcaption>
</figure>
<p>一方, 時刻<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>で, 位相が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>から<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>に変化したとする.
この時のSilencerによる位相変化は以下の図のようになる.
これは, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>よりも, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">2</span></span></span></span>のほうが近いためである.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/silent/phase2.svg"/>
<figcaption>位相<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>の変化 (位相変化量が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>より大きい場合)</figcaption>
</figure>
<p>つまり, Silencerは現在の<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>と目標値<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>に対して
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm">sign</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">∣</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">Δ</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm">sign</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">∣</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">Δ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">/2</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">(otherwise)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span></span></span></span></span>
として位相<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>を更新する.
ここで, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span></span></span></span>は1ステップ当たりの更新量 (<code>Silencer</code>の<code>step</code>) を表す.
なお, 更新周波数は<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord"><span class="mord">40</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">kHz</span></span></span></span></span></span>となっている.</p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span></span></span></span>が小さいほど, 位相変化はなだらかになり騒音が抑制される.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/silent/duty.svg"/>
<figcaption><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span></span></span></span>による変化の違い</figcaption>
</figure>
<p>この実装の都合上, 移動平均フィルタとは異なる挙動を示す場合がある.
一つは, 上に示した位相変化量が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>より大きい場合であり, もう一つが, 途中でもう一度位相が変化する場合である.
この時の位相変化の例を以下に示す.
元時系列に対する忠実度という観点では移動平均フィルタが正しいが, 位相変化量が<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>より大きい場合を考慮したり, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span></span></span></span>を可変にする (即ち, フィルタ長を可変にする) のが大変なため現在のような実装となっている.</p>
<figure>
  <img src="Users_Manual/../fig/Users_Manual/silent/mean.svg"/>
<figcaption>移動平均フィルタとの比較</figcaption>
</figure>
<h2 id="silencerによるduty比の変化"><a class="header" href="#silencerによるduty比の変化">SilencerによるDuty比の変化</a></h2>
<p>振幅変動が騒音を引き起こすので, Duty比<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>も同等のフィルタをかけることでAMによる騒音を抑制できる.</p>
<p>Duty比<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>は位相とは異なり周期的ではないので, 現在の<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>と目標値<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>に対して
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">sign</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">Δ</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span>
のように更新する.</p>
<div class="footnote-definition" id="suzuki2020"><sup class="footnote-definition-label">1</sup>
<p>Suzuki, Shun, et al. “Reducing amplitude fluctuation by gradual phase shift in midair ultrasound haptics.” IEEE transactions on haptics 13.1 (2020): 87-93.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="controller"><a class="header" href="#controller">Controller</a></h1>
<p>ここでは, <code>Controller</code>クラスに存在するAPIを紹介する.</p>
<ul>
<li><a href="Users_Manual/controller.html#fpga_info">fpga_info</a></li>
<li><a href="Users_Manual/controller.html#send">send</a>
<ul>
<li><a href="Users_Manual/controller.html#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88">タイムアウト</a></li>
<li><a href="Users_Manual/controller.html#stop">Stop</a></li>
<li><a href="Users_Manual/controller.html#clear">Clear</a></li>
</ul>
</li>
<li><a href="Users_Manual/controller.html#group">group</a></li>
</ul>
<h2 id="fpga_info"><a class="header" href="#fpga_info">fpga_info</a></h2>
<p>FPGAの状態を取得する.
これを使用する前に, <code>Device</code>の<code>reads_fpga_info</code>フラグをセットしておく必要がある.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().add_device(AUTD3::new(Vector3::zeros())).open_with(autd3::link::Nop::builder()).await?;
</span>autd.geometry[0].reads_fpga_info = true;
autd.send(UpdateFlags::new()).await?;

let info = autd.fpga_info();
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">autd.geometry()[0].reads_fpga_info(true);
autd.send(autd3::UpdateFlags());

const auto info = autd.fpga_info();
</code></pre>
<pre><code class="language-cs">autd.Geometry[0].ReadsFPGAInfo = true;
autd.Send(new UpdateFlags());

var info = autd.FPGAInfo;
</code></pre>
<pre><code class="language-python">from pyautd3 import UpdateFlags

autd.geometry[0].reads_fpga_info = True
autd.send(UpdateFlags())

info = autd.fpga_info
</code></pre>
<p>FPGAの状態としては, 現在以下の情報が取得できる.</p>
<ul>
<li>ファン制御用の温度センサがアサートされているかどうか</li>
</ul>
<h2 id="send"><a class="header" href="#send">send</a></h2>
<p>デバイスにデータを送信する.</p>
<p>データは単体か2つのみ同時に送信することができる.
ただし, <code>Stop</code>のみ例外で, 単体でしか送信できない.</p>
<h3 id="タイムアウト"><a class="header" href="#タイムアウト">タイムアウト</a></h3>
<p><code>with_timeout</code>でタイムアウト時間を指定できる.
これを省略した場合は<a href="Users_Manual/./link.html">Link</a>で設定したタイムアウト時間が使用される.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().open_with(autd3::link::Nop::builder()).await?;
</span><span class="boring">let m = Static::new();
</span><span class="boring">let g = Null::new();
</span>autd.send((m, g).with_timeout(std::time::Duration::from_millis(20))).await?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">autd.send(m, g, std::chrono::milliseconds(20));
</code></pre>
<pre><code class="language-cs">autd.Send((m, g), TimeSpan.FromMilliseconds(20));
</code></pre>
<pre><code class="language-python">from datetime import timedelta

autd.send((m, g), timeout=timedelta(milliseconds=20))
</code></pre>
<p>タイムアウトの値が0より大きい場合, 送信時に送信データがデバイスで処理されるか, 指定したタイムアウト時間が経過するまで待機する.
送信データがデバイスで処理されたのが確認できた場合に<code>send</code>関数は<code>true</code>を返し, そうでない場合は<code>false</code>を返す.</p>
<p>タイムアウトの値が0の場合, <code>send</code>関数はチェックを行わない.</p>
<p>確実にデータを送信したい場合はこれを適当な値に設定しておくことをおすすめする.</p>
<h3 id="stop"><a class="header" href="#stop">Stop</a></h3>
<p><code>Stop</code>を送信すると, 出力を止めることができる.</p>
<p><code>Stop</code>を送信すると, Silencerの設定がリセットされるので注意されたい.</p>
<h3 id="clear"><a class="header" href="#clear">Clear</a></h3>
<p><code>Clear</code>を送信すると, デバイス内のフラグや<code>Gain</code>/<code>Modulation</code>データ等をクリアする.</p>
<h2 id="group-1"><a class="header" href="#group-1">group</a></h2>
<p><code>group</code>関数を使用すると, デバイスをグルーピングすることができる.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::builder().add_device(AUTD3::new(Vector3::zeros())).add_device(AUTD3::new(Vector3::zeros())).open_with(autd3::link::Nop::builder()).await?;
</span><span class="boring">let x = 0.;
</span><span class="boring">let y = 0.;
</span><span class="boring">let z = 0.;
</span>autd.group(|dev| match dev.idx() {
        0 =&gt; Some(&quot;focus&quot;),
        1 =&gt; Some(&quot;null&quot;),
        _ =&gt; None,
    })
    .set(&quot;null&quot;, Null::new())?
    .set(&quot;focus&quot;, Focus::new(Vector3::new(x, y, z)))?
    .send().await?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">autd.group([](const autd3::Device&amp; dev) -&gt; std::optional&lt;const char*&gt; {
      if (dev.idx() == 0) {
        return &quot;null&quot;;
      } else if (dev.idx() == 1) {
        return &quot;focus&quot;;
      } else {
        return std::nullopt;
      }
    })
    .set(&quot;null&quot;, autd3::gain::Null())
    .set(&quot;focus&quot;, autd3::gain::Focus(autd3::Vector3(x, y, z)))
    .send_async()
    .get();
</code></pre>
<pre><code class="language-cs">using AUTD3Sharp.Gain;
using AUTD3Sharp.Utils;

await autd.Group(dev =&gt;
    {
        return dev.Idx switch
        {
            0 =&gt; &quot;null&quot;,
            1 =&gt; &quot;focus&quot;,
            _ =&gt; null
        };
    })
    .Set(&quot;null&quot;, new Null())
    .Set(&quot;focus&quot;, new Focus(new Vector3d(x, y, z)))
    .SendAsync();
</code></pre>
<pre><code class="language-python">from pyautd3.gain import Focus, Null


def grouping(dev):
    if dev.idx == 0:
        return &quot;null&quot;
    elif dev.idx == 1:
        return &quot;focus&quot;
    else:
        return None


await (
    autd.group(grouping)
    .set_data(&quot;null&quot;, Null())
    .set_data(&quot;focus&quot;, Focus([x, y, z]))
    .send_async()
)
</code></pre>
<p><code>gain::Group</code>とは異なり, 通常の<code>send</code>で送信できるデータなら何でも使用できる.
ただし, デバイス単位でしかグルーピングできない.</p>
<p>なお, タイムアウトは, <code>set</code>したものの中で最大のものが使用される.
<code>set</code>したものの中にタイムアウトを指定したものがなければ, <a href="Users_Manual/./link.html">Link</a>で設定したタイムアウト時間が使用される.</p>
<blockquote>
<p>NOTE:
このサンプルでは, キーとして文字列を使用しているが, HashMapのキーとして使用できるものなら何でも良い.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="上級者向けサンプル"><a class="header" href="#上級者向けサンプル">上級者向けサンプル</a></h1>
<p>以下では, 上級者向けのサンプルを紹介する.</p>
<ul>
<li><a href="Users_Manual/advanced_examples/./custom_gain.html">Gainの自作</a></li>
<li><a href="Users_Manual/advanced_examples/./custom_modulation.html">Modulationの自作</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="gainの自作"><a class="header" href="#gainの自作">Gainの自作</a></h1>
<p>ライブラリでは自前の<code>Gain</code>を作成することができる.</p>
<p>ここでは, <code>Focus</code>と同じように単一焦点を生成する<code>FocalPoint</code>を実際に定義してみることにする.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate autd3_driver;
</span>use std::collections::HashMap;
use autd3::{
    derive::Gain,
    prelude::*,
};
use autd3_driver::derive::prelude::*;

#[derive(Gain)]
pub struct FocalPoint {
    position: Vector3,
}

impl FocalPoint {
    pub fn new(position: Vector3) -&gt; Self {
        Self {position}
    }
}

impl Gain for FocalPoint {
    fn calc(&amp;self, geometry: &amp;Geometry, filter: GainFilter) -&gt; Result&lt;HashMap&lt;usize, Vec&lt;Drive&gt;&gt;, AUTDInternalError&gt; {
        Ok(Self::transform(geometry, filter, |dev, tr| Drive {
            phase: Phase::from_rad((tr.position() - self.position).norm() * tr.wavelength(dev.sound_speed)),
            intensity: EmitIntensity::MAX,
        }))
    }
}
<span class="boring">fn main() { 
</span><span class="boring">}
</span><span class="boring"></span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

class FocalPoint final : public autd3::Gain {
 public:
  explicit FocalPoint(autd3::Vector3 point) : _point(std::move(point)) {}

  std::unordered_map&lt;size_t, std::vector&lt;autd3::Drive&gt;&gt; calc(
      const autd3::Geometry&amp; geometry) const override {
    return autd3::Gain::transform(
        geometry, [&amp;](const auto&amp; dev, const auto&amp; tr) {
          const auto phase = (tr.position() - _point).norm() *
                             tr.wavelength(dev.sound_speed());
          return autd3::Drive{autd3::Phase::from_rad(phase),
                              autd3::EmitIntensity::maximum()};
        });
  }

 private:
  autd3::Vector3 _point;
};
</code></pre>
<pre><code class="language-cs">public class FocalPoint : Gain
{
    private readonly Vector3d _point;

    public FocalPoint(Vector3d point)
    {
        _point = point;
    }

    public override Dictionary&lt;int, Drive[]&gt; Calc(Geometry geometry)
    {
        return Transform(geometry, (dev, tr) =&gt;
        {
            var tp = tr.Position;
            var dist = (tp - _point).L2Norm;
            var phase = dist * tr.Wavenumber(dev.SoundSpeed);
            return new Drive { Phase = Phase.FromRad(phase), Intensity = EmitIntensity.Max };
        });
    }
}
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3 import Drive, EmitIntensity, Geometry, Phase
from pyautd3.gain import Gain


class Focus(Gain):
    def __init__(self, point):
        self.point = np.array(point)

    def calc(self, geometry: Geometry) -&gt; dict[int, np.ndarray]:
        return Gain._transform(
            geometry,
            lambda dev, tr: Drive(
                Phase.from_rad(
                    np.linalg.norm(tr.position - self.point)
                    * tr.wavenumber(dev.sound_speed)
                ),
                EmitIntensity.maximum(),
            ),
        )
</code></pre>
<p><code>send</code>関数は<code>Gain</code>型を継承したクラスを引数に取ることができる.
そのため, <code>Gain</code>型を継承をしておく.</p>
<p><code>send</code>関数内部では<code>Geometry</code>を引数にした<code>calc</code>メソッドが呼ばれ, その返り値の振幅/位相データが使用される.
そのため, この<code>calc</code>メソッド内で位相/振幅の計算を行えば良い.</p>
<p><code>calc</code>の返り値は, デバイスのインデックスをキー, そのデバイスの振幅位相データベクトルを値とする<code>HashMap</code>である.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="modulationの自作"><a class="header" href="#modulationの自作">Modulationの自作</a></h1>
<p><code>Modulation</code>も独自のものを作成することができる.
ここでは, 周期中のある一瞬だけ出力する<code>Burst</code>を作ってみる<sup class="footnote-reference"><a href="#fn_burst">1</a></sup>.</p>
<p>以下が, この<code>Burst</code>のサンプルである.</p>
<pre><code class="language-rust edition2021"><span class="boring">extern crate autd3;
</span><span class="boring">extern crate tokio;
</span><span class="boring">extern crate autd3_driver;
</span>use autd3::{
    derive::Modulation,
};
use autd3_driver::derive::prelude::*;

#[derive(Modulation)]
pub struct Burst {
    config: SamplingConfiguration,
}

impl Burst {
    pub fn new() -&gt; Self {
        Self { config: SamplingConfiguration::from_frequency(4e3).unwrap() }
    }
}

impl Modulation for Burst {
    fn calc(&amp;self) -&gt; Result&lt;Vec&lt;EmitIntensity&gt;, AUTDInternalError&gt; {
        Ok((0..4000)
            .map(|i| if i == 3999 { EmitIntensity::MAX } else { EmitIntensity::MIN })
            .collect())
    }
}
<span class="boring">fn main() { 
</span><span class="boring">}</span></code></pre>
<pre><code class="language-cpp">#include &quot;autd3.hpp&quot;

class BurstModulation final : public autd3::Modulation {
 public:
  std::vector&lt;autd3::EmitIntensity&gt; calc() const override {
    std::vector buffer(_buf_size, autd3::EmitIntensity::minimum());
    buffer[_buf_size - 1] = autd3::EmitIntensity::maximum();
    return buffer;
  }

  explicit BurstModulation(const size_t buf_size = 4000) noexcept
      : autd3::Modulation(autd3::SamplingConfiguration::from_frequency(4e3)), _buf_size(buf_size) {}

 private:
  size_t _buf_size;
};
</code></pre>
<pre><code class="language-cs">public class Burst : Modulation
{
    private readonly int _length;

    public Burst(int length) : base(SamplingConfiguration.FromFrequency(4e3))
    {
        _length = length;
    }

    public override EmitIntensity[] Calc()
    {
        var buf = Enumerable.Repeat&lt;EmitIntensity&gt;(EmitIntensity.Min, _length).ToArray();
        buf[0] = EmitIntensity.Max;
        return buf;
    }
}
</code></pre>
<pre><code class="language-python">import numpy as np
from pyautd3 import EmitIntensity, SamplingConfiguration
from pyautd3.modulation import Modulation


class Burst(Modulation):
    _length: int

    def __init__(self, length: int = 4000):
        super().__init__(SamplingConfiguration.from_frequency(4e3))
        self._length = length

    def calc(self):
        buf = np.array([EmitIntensity.minimum()] * self._length)
        buf[0] = EmitIntensity.maximum()
        return buf
</code></pre>
<p><code>Modulation</code>も<code>Gain</code>と同じく, <code>send</code>内部で<code>calc</code>メソッドが呼ばれ, その返り値の変調データが使用される.
したがって, この<code>calc</code>の中で, 変調データを計算すれば良い.</p>
<div class="footnote-definition" id="fn_burst"><sup class="footnote-definition-label">1</sup>
<p>SDKにはない.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="autd3-simulator"><a class="header" href="#autd3-simulator">AUTD3 Simulator</a></h1>
<p>AUTD Simulator (以下, シミュレータ) はその名の通りAUTDのシミュレータであり, Windows/Linux/macOSで動作する.</p>
<h2 id="autd-server-2"><a class="header" href="#autd-server-2">AUTD Server</a></h2>
<p>シミュレータは<code>AUTD Server</code>に付属している.
<a href="https://github.com/shinolab/autd3/releases">GitHub Releases</a>にてインストーラを配布しているので, これをダウンロードし, 指示に従ってインストールする.</p>
<p><code>AUTD Server</code>を実行すると, 以下のような画面になるので, <code>Simulator</code>タブを開き, <code>Run</code>ボタンを押すとシミュレータが起動する.</p>
<figure>
  <img src="Users_Manual/Simulator/../../fig/Users_Manual/autdserver_simulator.jpg"/>
</figure>
<p>シミュレータが起動すると接続待ちの状態になる.</p>
<figure>
  <img src="Users_Manual/Simulator/../../fig/sim_waiting.jpg"/>
</figure>
<p>この状態で, <code>Simulator</code>リンクを使って<code>Controller</code>を<code>open</code>すると, シミュレータ上には, 振動子の位置に円と, 画面中央に黒いパネルが表示される.</p>
<figure>
  <img src="Users_Manual/Simulator/../../fig/sim_init.jpg"/>
</figure>
<p>この黒いパネルを“Slice“と呼び, この“Slice“を使って任意の位置の音場を可視化できる.
また, その時, 振動子の位相が色相で, 振幅が色強度で表される.</p>
<figure>
  <img src="Users_Manual/Simulator/../../fig/sim_focus.jpg"/>
</figure>
<p>なお, シミュレータで表示される音場はシンプルな球面波の重ね合わせであり, 指向性や非線形効果などは考慮されない.</p>
<p>画面左に表示されているGUIでSliceやカメラの操作が行える.
なお, GUIには<a href="https://github.com/ocornut/imgui">Dear ImGui</a>を用いており, マウスによる操作のほか, “Ctrl+クリック“で数値入力モードになる.</p>
<h3 id="sliceタブ"><a class="header" href="#sliceタブ">Sliceタブ</a></h3>
<p>SliceタブではSliceの大きさと位置, 回転を変えられる.
回転はXYZのオイラー角で指定する.
なお, 「xy」, 「yz」, 「zx」ボタンを押すと, Sliceを各平面に平行な状態へ回転させる.</p>
<p>また, 音圧を表示する「Acoustic」モードか, その2乗の値を表示する「Radiation」モードを選択できる.</p>
<p>また, 「Color settings」の項目ではカラーリングのパレットの変更や, color scale, Slice自体のアルファ値の変更ができる.
大量のデバイスを使用すると色が飽和する場合があるので, その時はColor scaleの値を大きくすれば良い.</p>
<h3 id="cameraタブ"><a class="header" href="#cameraタブ">Cameraタブ</a></h3>
<p>Cameraタブではカメラの位置, 回転, Field of View, Near clip, Far clipの設定を変えられる.
回転はXYZのオイラー角で指定する.</p>
<h3 id="configタブ"><a class="header" href="#configタブ">Configタブ</a></h3>
<p>Configタブでは音速とフォントサイズ, 及び, 背景色の設定ができる.</p>
<p>また, 各デバイスごとのshow/enable/overheatの設定を切り替えられる.
showをOffにした場合は, 表示されないだけで音場に寄与する.
enableをOffにすると音場に寄与しなくなる.
また, overheatをOnにすると, 温度センサがアサートされた状態を模擬できる.</p>
<p>「View as device」をOnにすると, 振動子を単なる円ではなく, AUTD3の3Dモデルで表示する.</p>
<h3 id="infoタブ"><a class="header" href="#infoタブ">Infoタブ</a></h3>
<p>Infoタブでは, FPSや各デバイス毎のSilencerやModulation, STMの情報が確認できる.</p>
<p>Silencerの設定は確認できるがこれは音場には反映されない.</p>
<p>「Mod enable」をOnにすると, Modulationが音場に反映されるようになる.</p>
<p>ModulationとSTMは実時間を元にどのインデックスのデータを出力するかを決めている.
この時間を表すのが, 「System time」であり, 2000年1月1日0時0分0秒からの経過時間をナノ秒単位で表す.</p>
<p>「Auto play」をOnにすると「System time」が自動的に設定される.
そうでない場合は, 手動で時間を進めることができる.</p>
<h3 id="その他"><a class="header" href="#その他">その他</a></h3>
<p>「Save image as file」にて, 現在のSliceに表示されている音場を画像で保存できる.</p>
<p>「Auto」ボタンはカメラを自動的に適当な場所に移動させる.
「Reset」は起動時の状態にリセットする.
「Default」はデフォルトの設定にリセットする.</p>
<p>また, 設定は“settings.json“に保存される.
このファイルからしか変更できないものとして<code>vsync</code>がある.
<code>vsync</code>を<code>false</code>にすると垂直同期が無効になる.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<ul>
<li><a href="Users_Manual/FAQ/faq.html#no-autd3-devices-found%E3%81%A8%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%82%8B">“No AUTD3 devices found“と表示される</a></li>
<li><a href="Users_Manual/FAQ/faq.html#one-ore-more-slaves-are-not-responding%E3%81%A8%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%82%8B">“One ore more slaves are not responding“と表示される</a></li>
<li><a href="Users_Manual/FAQ/faq.html#linksoem%E4%BD%BF%E7%94%A8%E6%99%82%E3%81%AB%E9%80%81%E4%BF%A1%E3%81%8C%E9%A0%BB%E7%B9%81%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%99%E3%82%8B"><code>link::SOEM</code>使用時に送信が頻繁に失敗する</a></li>
<li><a href="Users_Manual/FAQ/faq.html#%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%8C%E9%A0%BB%E7%B9%81%E3%81%AB%E9%80%94%E5%88%87%E3%82%8C%E3%82%8B">リンクが頻繁に途切れる</a></li>
<li><a href="Users_Manual/FAQ/faq.html#remotetwincat%E3%83%AA%E3%83%B3%E3%82%AF%E4%BD%BF%E7%94%A8%E6%99%82%E3%81%AB%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E5%87%BA%E3%82%8B"><code>RemoteTwinCAT</code>リンク使用時にエラーが出る</a></li>
<li><a href="Users_Manual/FAQ/faq.html#%E6%8C%AF%E5%8B%95%E5%AD%90%E3%81%AE%E4%BD%8D%E7%9B%B8%E6%8C%AF%E5%B9%85%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF">振動子の位相/振幅データにアクセスするには?</a></li>
<li><a href="Users_Manual/FAQ/faq.html#am%E5%A4%89%E8%AA%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF">AM変調データにアクセスするには?</a></li>
<li><a href="Users_Manual/FAQ/faq.html#%E3%81%9D%E3%81%AE%E4%BB%96">その他</a></li>
</ul>
<h2 id="no-autd3-devices-foundと表示される"><a class="header" href="#no-autd3-devices-foundと表示される">“No AUTD3 devices found“と表示される</a></h2>
<ul>
<li>
<p>macOS, linuxで<code>link::SOEM</code>を使用する場合, root権限が必要</p>
<ul>
<li>
<p>linuxの場合, <code>setcap</code>コマンドで以下の権限を設定することで回避することもできる</p>
<pre><code class="language-shell">sudo setcap cap_net_raw,cap_net_admin=eip &lt;your executable file&gt;
</code></pre>
</li>
<li>
<p>macOSの場合, <code>/dev/bpf*</code>ファイルに読み取り権限を追加することで回避することもできる</p>
<pre><code class="language-shell">sudo chmod +r /dev/bpf*
</code></pre>
</li>
</ul>
</li>
<li>
<p>(Windows) 最新のnpcapを使用する</p>
</li>
<li>
<p>WSL等の仮想マシンは対応していない</p>
<ul>
<li>VirtualBoxなどで動く場合があるが, 挙動は不安定になる</li>
</ul>
</li>
</ul>
<h2 id="one-ore-more-slaves-are-not-respondingと表示される"><a class="header" href="#one-ore-more-slaves-are-not-respondingと表示される">“One ore more slaves are not responding“と表示される</a></h2>
<ul>
<li>
<p>Driverを更新する</p>
<ul>
<li>WindowsでRealtekを利用している場合, <a href="https://www.realtek.com/ja/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-pci-express-software">公式サイト</a>から<code>Win10 Auto Installation Program (NDIS)</code>と書かれた方のDriverをインストールすること (Windows 11でも).</li>
</ul>
</li>
<li>
<p>(Windows) 最新のnpcapを使用する</p>
</li>
<li>
<p><code>send_cycle</code>と<code>sync0_cycle</code>の値を増やす</p>
</li>
</ul>
<h2 id="linksoem使用時に送信が頻繁に失敗する"><a class="header" href="#linksoem使用時に送信が頻繁に失敗する"><code>link::SOEM</code>使用時に送信が頻繁に失敗する</a></h2>
<ul>
<li>
<p>この問題は</p>
<ul>
<li><code>sync_mode</code>を<code>DC</code>にしている</li>
</ul>
<p>かつ,</p>
<ul>
<li>オンボードのethernetインターフェースを使用している</li>
</ul>
<p>かつ, 以下のいずれかの状況で発生することが確認されている</p>
<ul>
<li>RealSense, Azure Kinect, Webカメラ等を使用する
<ul>
<li>基本的にカメラをアクティブにした時点で発生</li>
</ul>
</li>
<li>動画や音声を再生する
<ul>
<li>または, インターネットブラウザで動画サイト (Youtube等) を開く</li>
</ul>
</li>
<li>Unityを使用する
<ul>
<li>起動するだけで発生</li>
</ul>
</li>
<li>Blenderでアニメーションを再生する
<ul>
<li>その他の操作 (モデリング等) は問題ない</li>
</ul>
</li>
</ul>
</li>
<li>
<p>この問題の回避策としては, 以下のいずれかを試されたい</p>
<ol>
<li><code>timer_strategy</code>を<code>NativeTimer</code>にする</li>
<li><code>sync_mode</code>を<code>FreeRun</code>にする</li>
<li>Linuxやmacを使用する.
<ul>
<li>ただし, 仮想マシンはNG</li>
</ul>
</li>
<li><code>TwinCAT</code>, <code>RemoteTwinCAT</code>, または, <code>RemoteSOEM</code>リンクを使用する</li>
<li>USB to Ethernetアダプターを使用する
<ul>
<li>少なくとも「ASIX AX88179」のチップを採用しているもので正常に動作することが確認されている</li>
<li>なお, オンボードではなくとも, PCIe接続のethernetアダプターでも同様の問題が発生する</li>
</ul>
</li>
</ol>
</li>
<li>
<p>上記以外の状況でも発生した, 或いは, 上記状況でも発生しなかった等の報告があれば, <a href="https://github.com/shinolab/autd3/issues/20">GitHubのIssue</a>に積極的に報告していただけると幸いである.</p>
</li>
</ul>
<h2 id="リンクが頻繁に途切れる"><a class="header" href="#リンクが頻繁に途切れる">リンクが頻繁に途切れる</a></h2>
<ul>
<li>超音波の出力時にこれが頻発する場合は, 電力が足りているかを確認すること
<ul>
<li>デバイス一台で最大50W消費する</li>
</ul>
</li>
</ul>
<h2 id="remotetwincatリンク使用時にエラーが出る"><a class="header" href="#remotetwincatリンク使用時にエラーが出る"><code>RemoteTwinCAT</code>リンク使用時にエラーが出る</a></h2>
<ul>
<li>ファイアウォールでブロックされている可能性があるため, ファイアウォールを切るか, TCP/UDPの48898番ポートを開ける.</li>
<li>クライアントPCのサーバー以外とのLANをすべて切断する.</li>
</ul>
<h2 id="振動子の位相振幅データにアクセスするには"><a class="header" href="#振動子の位相振幅データにアクセスするには">振動子の位相/振幅データにアクセスするには?</a></h2>
<ol>
<li><a href="Users_Manual/FAQ/../gain/transform.html"><code>Transform</code></a>を利用する.</li>
<li>自分で所望の<code>Gain</code>を作成する. <a href="Users_Manual/FAQ/../advanced_examples/custom_gain.html">Gainの自作</a>を参照.</li>
</ol>
<h2 id="am変調データにアクセスするには"><a class="header" href="#am変調データにアクセスするには">AM変調データにアクセスするには?</a></h2>
<ol>
<li><a href="Users_Manual/FAQ/../modulation/transform.html"><code>Transform</code></a>を利用する.</li>
<li>自分で所望の<code>Modulation</code>を作成する. <a href="Users_Manual/FAQ/../advanced_examples/custom_modulation.html">Modulationの自作</a>を参照.</li>
</ol>
<h2 id="その他-1"><a class="header" href="#その他-1">その他</a></h2>
<ul>
<li>質問やバグ報告は<a href="https://github.com/shinolab/autd3/issues">GithubのIssue</a>へお気軽にどうぞ</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="引用"><a class="header" href="#引用">引用</a></h1>
<p>本SDKを使用する場合は, 以下の論文の引用を検討されたい.</p>
<ul>
<li><a href="https://ieeexplore.ieee.org/document/9392322">S. Suzuki, S. Inoue, M. Fujiwara, Y. Makino and H. Shinoda, “AUTD3: Scalable Airborne Ultrasound Tactile Display,” in IEEE Transactions on Haptics, doi: 10.1109/TOH.2021.3069976.</a></li>
<li>S. Inoue, Y. Makino and H. Shinoda “Scalable Architecture for Airborne Ultrasound Tactile Display”, Asia Haptics 2016</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="license"><a class="header" href="#license">LICENSE</a></h1>
<p>autd3ライブラリ自体はMITライセンスである.</p>
<p>詳細は<a href="https://github.com/shinolab/autd3/blob/master/LICENSE">LICENSE</a>を参照されたい.</p>
<h2 id="3rdparty-library-license"><a class="header" href="#3rdparty-library-license">3rdparty library license</a></h2>
<ul>
<li>SOEM link は<a href="https://github.com/OpenEtherCATsociety/SOEM">SOEM</a>を使用している</li>
<li>RemoteTwinCAT linkは<a href="https://github.com/Beckhoff/ADS">ADS</a>ライブラリを使用している</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="release-notes"><a class="header" href="#release-notes">Release Notes</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Date</th><th style="text-align: left">Version</th></tr></thead><tbody>
<tr><td style="text-align: left">2022/05/17</td><td style="text-align: left">2.0.0</td></tr>
<tr><td style="text-align: left">2022/05/22</td><td style="text-align: left">2.0.1</td></tr>
<tr><td style="text-align: left">2022/05/24</td><td style="text-align: left">2.0.2</td></tr>
<tr><td style="text-align: left">2022/05/25</td><td style="text-align: left">2.0.3</td></tr>
<tr><td style="text-align: left">2022/06/02</td><td style="text-align: left">2.1.0</td></tr>
<tr><td style="text-align: left">2022/06/10</td><td style="text-align: left">2.2.0</td></tr>
<tr><td style="text-align: left">2022/06/22</td><td style="text-align: left">2.2.1</td></tr>
<tr><td style="text-align: left">2022/06/29</td><td style="text-align: left">2.2.2</td></tr>
<tr><td style="text-align: left">2022/08/08</td><td style="text-align: left">2.3.0</td></tr>
<tr><td style="text-align: left">2022/08/14</td><td style="text-align: left">2.3.1</td></tr>
<tr><td style="text-align: left">2022/09/28</td><td style="text-align: left">2.4.0</td></tr>
<tr><td style="text-align: left">2022/10/09</td><td style="text-align: left">2.4.1</td></tr>
<tr><td style="text-align: left">2022/10/14</td><td style="text-align: left">2.4.2</td></tr>
<tr><td style="text-align: left">2022/10/18</td><td style="text-align: left">2.4.3</td></tr>
<tr><td style="text-align: left">2022/10/21</td><td style="text-align: left">2.4.4</td></tr>
<tr><td style="text-align: left">2022/10/25</td><td style="text-align: left">2.4.5</td></tr>
<tr><td style="text-align: left">2022/11/04</td><td style="text-align: left">2.5.0</td></tr>
<tr><td style="text-align: left">2022/11/06</td><td style="text-align: left">2.5.1</td></tr>
<tr><td style="text-align: left">2022/11/08</td><td style="text-align: left">2.5.2</td></tr>
<tr><td style="text-align: left">2022/11/10</td><td style="text-align: left">2.6.0</td></tr>
<tr><td style="text-align: left">2022/11/13</td><td style="text-align: left">2.6.1</td></tr>
<tr><td style="text-align: left">2022/11/15</td><td style="text-align: left">2.6.2</td></tr>
<tr><td style="text-align: left">2022/11/21</td><td style="text-align: left">2.6.3</td></tr>
<tr><td style="text-align: left">2022/11/22</td><td style="text-align: left">2.6.4</td></tr>
<tr><td style="text-align: left">2022/11/28</td><td style="text-align: left">2.6.5</td></tr>
<tr><td style="text-align: left">2022/12/06</td><td style="text-align: left">2.6.6</td></tr>
<tr><td style="text-align: left">2022/12/10</td><td style="text-align: left">2.6.7</td></tr>
<tr><td style="text-align: left">2022/12/13</td><td style="text-align: left">2.6.8</td></tr>
<tr><td style="text-align: left">2022/12/16</td><td style="text-align: left">2.7.0</td></tr>
<tr><td style="text-align: left">2022/12/24</td><td style="text-align: left">2.7.1</td></tr>
<tr><td style="text-align: left">2022/12/29</td><td style="text-align: left">2.7.2</td></tr>
<tr><td style="text-align: left">2023/01/12</td><td style="text-align: left">2.7.4</td></tr>
<tr><td style="text-align: left">2023/01/17</td><td style="text-align: left">2.7.5</td></tr>
<tr><td style="text-align: left">2023/01/18</td><td style="text-align: left">2.7.6</td></tr>
<tr><td style="text-align: left">2023/01/24</td><td style="text-align: left">2.8.0</td></tr>
<tr><td style="text-align: left">2023/02/02</td><td style="text-align: left">8.1.0</td></tr>
<tr><td style="text-align: left">2023/02/03</td><td style="text-align: left">8.1.1</td></tr>
<tr><td style="text-align: left">2023/02/19</td><td style="text-align: left">8.1.2</td></tr>
<tr><td style="text-align: left">2023/03/10</td><td style="text-align: left">8.2.0</td></tr>
<tr><td style="text-align: left">2023/03/21</td><td style="text-align: left">8.3.0</td></tr>
<tr><td style="text-align: left">2023/04/18</td><td style="text-align: left">8.4.0</td></tr>
<tr><td style="text-align: left">2023/04/23</td><td style="text-align: left">8.4.1</td></tr>
<tr><td style="text-align: left">2023/04/26</td><td style="text-align: left">8.5.0</td></tr>
<tr><td style="text-align: left">2023/04/29</td><td style="text-align: left">9.0.0</td></tr>
<tr><td style="text-align: left">2023/05/01</td><td style="text-align: left">9.0.1</td></tr>
<tr><td style="text-align: left">2023/05/30</td><td style="text-align: left">10.0.0</td></tr>
<tr><td style="text-align: left">2023/06/08</td><td style="text-align: left">11.0.0</td></tr>
<tr><td style="text-align: left">2023/06/09</td><td style="text-align: left">11.0.1</td></tr>
<tr><td style="text-align: left">2023/06/09</td><td style="text-align: left">11.0.2</td></tr>
<tr><td style="text-align: left">2023/06/12</td><td style="text-align: left">11.1.0</td></tr>
<tr><td style="text-align: left">2023/06/21</td><td style="text-align: left">12.0.0</td></tr>
<tr><td style="text-align: left">2023/06/22</td><td style="text-align: left">12.1.0</td></tr>
<tr><td style="text-align: left">2023/06/23</td><td style="text-align: left">12.1.1</td></tr>
<tr><td style="text-align: left">2023/06/24</td><td style="text-align: left">12.2.0</td></tr>
<tr><td style="text-align: left">2023/07/04</td><td style="text-align: left">12.3.0</td></tr>
<tr><td style="text-align: left">2023/07/04</td><td style="text-align: left">12.3.1</td></tr>
<tr><td style="text-align: left">2023/07/11</td><td style="text-align: left">13.0.0</td></tr>
<tr><td style="text-align: left">2023/07/18</td><td style="text-align: left">14.0.0</td></tr>
<tr><td style="text-align: left">2023/07/19</td><td style="text-align: left">14.0.1</td></tr>
<tr><td style="text-align: left">2023/07/27</td><td style="text-align: left">14.1.0</td></tr>
<tr><td style="text-align: left">2023/07/28</td><td style="text-align: left">14.2.0</td></tr>
<tr><td style="text-align: left">2023/08/01</td><td style="text-align: left">14.2.1</td></tr>
<tr><td style="text-align: left">2023/08/07</td><td style="text-align: left">14.2.2</td></tr>
<tr><td style="text-align: left">2023/09/14</td><td style="text-align: left">15.0.2</td></tr>
<tr><td style="text-align: left">2023/09/14</td><td style="text-align: left">15.1.0</td></tr>
<tr><td style="text-align: left">2023/09/15</td><td style="text-align: left">15.1.1</td></tr>
<tr><td style="text-align: left">2023/09/22</td><td style="text-align: left">15.1.2</td></tr>
<tr><td style="text-align: left">2023/09/28</td><td style="text-align: left">15.2.0</td></tr>
<tr><td style="text-align: left">2023/09/29</td><td style="text-align: left">15.2.1</td></tr>
<tr><td style="text-align: left">2023/10/04</td><td style="text-align: left">15.3.0</td></tr>
<tr><td style="text-align: left">2023/10/04</td><td style="text-align: left">15.3.1</td></tr>
<tr><td style="text-align: left">2023/10/14</td><td style="text-align: left">16.0.0</td></tr>
<tr><td style="text-align: left">2023/11/27</td><td style="text-align: left">17.0.0</td></tr>
<tr><td style="text-align: left">2023/11/27</td><td style="text-align: left">17.0.1</td></tr>
<tr><td style="text-align: left">2023/11/28</td><td style="text-align: left">17.0.2</td></tr>
<tr><td style="text-align: left">2023/11/29</td><td style="text-align: left">17.0.3</td></tr>
<tr><td style="text-align: left">2023/12/02</td><td style="text-align: left">18.0.0</td></tr>
<tr><td style="text-align: left">2023/12/04</td><td style="text-align: left">18.0.1</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="document-history"><a class="header" href="#document-history">Document History</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Date</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">2022/05/17</td><td style="text-align: left">Version 2.0.0 初版</td></tr>
<tr><td style="text-align: left">2022/05/22</td><td style="text-align: left">Version 2.0.1 初版</td></tr>
<tr><td style="text-align: left">2022/05/23</td><td style="text-align: left">FFI/python, FFI/csharp, migration_guideを追加</td></tr>
<tr><td style="text-align: left">2022/05/24</td><td style="text-align: left">Version 2.0.2 初版</td></tr>
<tr><td style="text-align: left">2022/05/25</td><td style="text-align: left">Version 2.0.3 初版</td></tr>
<tr><td style="text-align: left">2022/06/02</td><td style="text-align: left">Version 2.1.0 初版</td></tr>
<tr><td style="text-align: left">2022/06/10</td><td style="text-align: left">Version 2.2.0 初版</td></tr>
<tr><td style="text-align: left">2022/06/22</td><td style="text-align: left">Version 2.2.1 初版</td></tr>
<tr><td style="text-align: left">2022/06/29</td><td style="text-align: left">Version 2.2.2 初版</td></tr>
<tr><td style="text-align: left">2022/07/28</td><td style="text-align: left">Version 2.2.2 FAQ, 及び, TwinCATに付いて追記</td></tr>
<tr><td style="text-align: left">2022/08/08</td><td style="text-align: left">Version 2.3.0 初版</td></tr>
<tr><td style="text-align: left">2022/08/14</td><td style="text-align: left">Version 2.3.1 初版</td></tr>
<tr><td style="text-align: left">2022/09/28</td><td style="text-align: left">Version 2.4.0 初版</td></tr>
<tr><td style="text-align: left">2022/10/09</td><td style="text-align: left">Version 2.4.1 初版</td></tr>
<tr><td style="text-align: left">2022/10/14</td><td style="text-align: left">Version 2.4.2 初版</td></tr>
<tr><td style="text-align: left">2022/10/18</td><td style="text-align: left">Version 2.4.3 初版</td></tr>
<tr><td style="text-align: left">2022/10/21</td><td style="text-align: left">Version 2.4.4 初版</td></tr>
<tr><td style="text-align: left">2022/10/25</td><td style="text-align: left">Version 2.4.5 初版</td></tr>
<tr><td style="text-align: left">2022/11/04</td><td style="text-align: left">Version 2.5.0 初版</td></tr>
<tr><td style="text-align: left">2022/11/06</td><td style="text-align: left">Version 2.5.1 初版</td></tr>
<tr><td style="text-align: left">2022/11/08</td><td style="text-align: left">Version 2.5.2 初版</td></tr>
<tr><td style="text-align: left">2022/11/10</td><td style="text-align: left">Version 2.6.0 初版</td></tr>
<tr><td style="text-align: left">2022/11/13</td><td style="text-align: left">Version 2.6.1 初版</td></tr>
<tr><td style="text-align: left">2022/11/15</td><td style="text-align: left">Version 2.6.2 初版</td></tr>
<tr><td style="text-align: left">2022/11/21</td><td style="text-align: left">Version 2.6.3 初版</td></tr>
<tr><td style="text-align: left">2022/11/22</td><td style="text-align: left">Version 2.6.4 初版</td></tr>
<tr><td style="text-align: left">2022/11/28</td><td style="text-align: left">Version 2.6.5 初版</td></tr>
<tr><td style="text-align: left">2022/12/06</td><td style="text-align: left">Version 2.6.6 初版</td></tr>
<tr><td style="text-align: left">2022/12/10</td><td style="text-align: left">Version 2.6.7 初版</td></tr>
<tr><td style="text-align: left">2022/12/13</td><td style="text-align: left">Version 2.6.8 初版</td></tr>
<tr><td style="text-align: left">2022/12/16</td><td style="text-align: left">Version 2.7.0 初版</td></tr>
<tr><td style="text-align: left">2022/12/24</td><td style="text-align: left">Version 2.7.1 初版</td></tr>
<tr><td style="text-align: left">2022/12/29</td><td style="text-align: left">Version 2.7.2 初版</td></tr>
<tr><td style="text-align: left">2023/01/12</td><td style="text-align: left">Version 2.7.4 初版</td></tr>
<tr><td style="text-align: left">2023/01/17</td><td style="text-align: left">Version 2.7.5 初版</td></tr>
<tr><td style="text-align: left">2023/01/18</td><td style="text-align: left">Version 2.7.6 初版</td></tr>
<tr><td style="text-align: left">2023/01/24</td><td style="text-align: left">Version 2.8.0 初版</td></tr>
<tr><td style="text-align: left">2023/02/02</td><td style="text-align: left">Version 8.1.0 初版</td></tr>
<tr><td style="text-align: left">2023/02/03</td><td style="text-align: left">Version 8.1.1 初版</td></tr>
<tr><td style="text-align: left">2023/02/19</td><td style="text-align: left">Version 8.1.2 初版</td></tr>
<tr><td style="text-align: left">2023/03/10</td><td style="text-align: left">Version 8.2.0 初版</td></tr>
<tr><td style="text-align: left">2023/03/21</td><td style="text-align: left">Version 8.3.0 初版</td></tr>
<tr><td style="text-align: left">2023/04/18</td><td style="text-align: left">Version 8.4.0 初版</td></tr>
<tr><td style="text-align: left">2023/04/23</td><td style="text-align: left">Version 8.4.1 初版</td></tr>
<tr><td style="text-align: left">2023/04/26</td><td style="text-align: left">Version 8.5.0 初版</td></tr>
<tr><td style="text-align: left">2023/04/29</td><td style="text-align: left">Version 9.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/05/01</td><td style="text-align: left">Version 9.0.1 初版</td></tr>
<tr><td style="text-align: left">2023/06/12</td><td style="text-align: left">Version 11.1.0 初版</td></tr>
<tr><td style="text-align: left">2023/06/21</td><td style="text-align: left">Version 12.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/06/22</td><td style="text-align: left">Version 12.1.0 初版</td></tr>
<tr><td style="text-align: left">2023/06/23</td><td style="text-align: left">Version 12.1.1 初版</td></tr>
<tr><td style="text-align: left">2023/06/24</td><td style="text-align: left">Version 12.2.0 初版</td></tr>
<tr><td style="text-align: left">2023/07/04</td><td style="text-align: left">Version 12.3.0 初版</td></tr>
<tr><td style="text-align: left">2023/07/04</td><td style="text-align: left">Version 12.3.1 初版</td></tr>
<tr><td style="text-align: left">2023/07/11</td><td style="text-align: left">Version 13.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/07/19</td><td style="text-align: left">Version 14.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/07/19</td><td style="text-align: left">Version 14.0.1 初版</td></tr>
<tr><td style="text-align: left">2023/07/27</td><td style="text-align: left">Version 14.1.0 初版</td></tr>
<tr><td style="text-align: left">2023/07/28</td><td style="text-align: left">Version 14.2.0 初版</td></tr>
<tr><td style="text-align: left">2023/08/01</td><td style="text-align: left">Version 14.2.1 初版</td></tr>
<tr><td style="text-align: left">2023/08/07</td><td style="text-align: left">Version 14.2.2 初版</td></tr>
<tr><td style="text-align: left">2023/09/14</td><td style="text-align: left">Version 15.0.2 初版</td></tr>
<tr><td style="text-align: left">2023/09/14</td><td style="text-align: left">Version 15.1.0 初版</td></tr>
<tr><td style="text-align: left">2023/09/15</td><td style="text-align: left">Version 15.1.1 初版</td></tr>
<tr><td style="text-align: left">2023/09/22</td><td style="text-align: left">Version 15.1.2 初版</td></tr>
<tr><td style="text-align: left">2023/09/28</td><td style="text-align: left">Version 15.2.0 初版</td></tr>
<tr><td style="text-align: left">2023/09/29</td><td style="text-align: left">Version 15.2.1 初版</td></tr>
<tr><td style="text-align: left">2023/10/04</td><td style="text-align: left">Version 15.3.0 初版</td></tr>
<tr><td style="text-align: left">2023/10/04</td><td style="text-align: left">Version 15.3.1 初版</td></tr>
<tr><td style="text-align: left">2023/10/14</td><td style="text-align: left">Version 16.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/11/28</td><td style="text-align: left">Version 17.0.2 初版</td></tr>
<tr><td style="text-align: left">2023/11/29</td><td style="text-align: left">Version 17.0.3 初版</td></tr>
<tr><td style="text-align: left">2023/12/02</td><td style="text-align: left">Version 18.0.0 初版</td></tr>
<tr><td style="text-align: left">2023/12/04</td><td style="text-align: left">Version 18.0.1 初版</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="./theme/codeblock_filename.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
